<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> CyberIntruder | Blog </title> <meta name="author" content="CyberIntruder - Molx32 "/> <meta name="description" content="This post is describes the architecture of the solution"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light"/> <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚛️</text></svg>"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://cyber-intruder.com/blog/2022/Update-management-03/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="https://cyber-intruder.com/">CyberIntruder</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/about">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/fr-fr/blog/2022/Update-management-03/"> FR-FR </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Azure Update Management - Part 4 - Log Analytics agents</h1> <p class="post-meta">September 2, 2022</p> <p class="post-tags"> <a href="/blog/2022"> <i class="fas fa-calendar fa-sm"></i> 2022 </a>   ·   <a href="/blog/tag/updatemanagement"> <i class="fas fa-hashtag fa-sm"></i> updatemanagement</a>   </p> </header> <article class="post-content"> <p><i>Hello there, the goal of this serie is to describe a real world implementation of <b>Azure Update Management</b>. This service was designed to update any machine in your infrastructure, whether they are hosted on Azure or elsewhere, provided your OSs are technically supported.</i></p> <p><i>In order for every reader to understand and find answers to their need, to I’ll try to give a comprehensive feedback from my experience, as well as sharing tips about design and architecture, automation, effectivement, troubleshooting issues, and so on!</i></p> <p><i>Have a nice reading.</i></p> <hr> <h4 id="plan">Plan</h4> <ul> <li><a href="/blog/2022/Update-management-00/">Part 0 - Introduction</a></li> <li><a href="/blog/2022/Update-management-01/">Part 1 - Architecture</a></li> <li><a href="/blog/2022/Update-management-011/">Part 2 - Azure Policy</a></li> <li><a href="/blog/2022/Update-management-02/">Part 3 - Azure ARC</a></li> <li><b><a href="/blog/2022/Update-management-03/">Part 4 - Log Analytics agents (you’re here)</a></b></li> <li><a href="/blog/2023/Update-management-04/">Part 5 - Automation accounts</a></li> <li><a href="/blog/2023/Update-management-05/">Part 6 - Monitoring</a></li> <li><a href="/blog/2023/Update-management-06/">Part 7 - Security patches on Azure ARC</a></li> <li><a href="/blog/2023/Update-management-07/">Part 8 - Security patches on CentOS machines</a></li> </ul> <hr> <h2 id="introduction">Introduction</h2> <p>In the previous post, we saw how to deploy Azure ARC. Now that all our machines are ready to be onboarded on the solution, let’s take a closer look at the core architecture, begining with Log Analytics.</p> <h2 id="log-analytics-workspaces">Log Analytics workspaces</h2> <h3 id="useful-information">Useful information</h3> <p>The Log Analytics service was designed to store logs for a defined period of time (retention). You can retrieve these logs by sending queries to the Log Analytics using a powerful language named Kusto Query Language (KQL). If you have monitoring routines, you can save queries as <b>Saved Searches</b> : this is important for the next part. The last thing that is useful to know in the context of this project is about billing : billing should be always configured on a Pay-As-You-Go basis when first deploying the resource (it can be changed later).</p> <h3 id="arm-template">ARM template</h3> <p>The Log Analytics workspace looks like this in an ARM object. We have the main object which is the Log Analytics, and we have a child object which is a <b>savedSearches</b>. There are some properties like “feature” that are mandatory but we can ignore, I already told you about the most important ones.</p> <figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Microsoft.OperationalInsights/workspaces"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"apiVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2020-08-01"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[parameters('workspaceName')]"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"location"</span><span class="p">:</span><span class="w"> </span><span class="s2">"westeurope"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"sku"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[parameters('sku')]"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"retentionInDays"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[parameters('dataRetention')]"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"features"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"searchVersion"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
          </span><span class="nl">"legacy"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
      </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"resources"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
      </span><span class="nl">"apiVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2020-08-01"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"savedSearches"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[variables('saved_search')]"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"dependsOn"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"category"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UpdateManagement"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"displayName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[variables('saved_search')]"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"functionAlias"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
          </span><span class="nl">"functionParameters"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
          </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Heartbeat | where Computer contains 'a-string-that-cant-be-matched' | distinct Computer"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
              </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Group"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Computer"</span><span class="w">
          </span><span class="p">}],</span><span class="w">
          </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w">
      </span><span class="p">}</span><span class="w">
  </span><span class="p">}]</span><span class="w">
</span><span class="p">}</span></code></pre></figure> <h2 id="log-analytics-agents">Log Analytics agents</h2> <h3 id="about-microsoft-agents">About Microsoft agents</h3> <p>Let’s take some time to talk about Microsoft agents, because I know this is often confusing. There is a <a href="https://learn.microsoft.com/en-us/azure/azure-monitor/agents/agents-overview" target="_blank" rel="noopener noreferrer">Microsoft documentation</a> page that will help you understand all of this. There are three main agents :</p> <ul> <li>Azure Monitoring Agent (AMA) - This is the most recent agent that was developed by Microsoft. For this reason, you’ll probably read about this agent since it is going to support most of the Azure services.</li> <li>Log Analytics Agent - This is the historic agent that will be replaced with the AMA. Altough it will reach end of support on August 2024, this is currently the agent to use to enable the Update Management service. Also, keep in mind that there is a new version of the Update Management service that works differently from what I describe in this serie, and that currently prevents to patch machines in a very flexible and dynamic way i.e. we can’t patch machines based on their tags.</li> <li>Diagnostics extension (WAD &amp; LAD) - This last agent works with an Azure extension that will collect many information from the system and allow you to monitor them. It could be useful to use this agent rather than the others if you need to monitor only Syslog and Performance (on Linux) for instance.</li> </ul> <p><u>Note</u> : LAD stands for something like Linux Azure Diagnostic and WAD for Windows Azure Diagnostic.</p> <table id="custom" class="t-border"> <caption style="text-align:center"><b>For Windows machines</b></caption> <tr> <th style="text-align:center"></th> <th style="text-align:center">Azure Monitor Agent</th> <th style="text-align:center">Log Analytics Agent</th> <th style="text-align:center">Diagnostics extension (WAD)</th> </tr> <tr> <td><b>Data collected</b></td> <td style="text-align:center"></td> <td style="text-align:center"></td> <td style="text-align:center"></td> </tr> <tr> <td>Event Logs</td> <td style="text-align:center">X</td> <td style="text-align:center">X</td> <td style="text-align:center">X</td> </tr> <tr> <td>Performance</td> <td style="text-align:center">X</td> <td style="text-align:center">X</td> <td style="text-align:center">X</td> </tr> <tr> <td>File based logs</td> <td style="text-align:center">X</td> <td style="text-align:center">X</td> <td style="text-align:center">X</td> </tr> <tr> <td>IIS logs</td> <td style="text-align:center">X</td> <td style="text-align:center">X</td> <td style="text-align:center">X</td> </tr> <tr> <td>ETW events</td> <td style="text-align:center"></td> <td style="text-align:center"></td> <td style="text-align:center">X</td> </tr> <tr> <td>.NET app logs</td> <td style="text-align:center"></td> <td style="text-align:center"></td> <td style="text-align:center">X</td> </tr> <tr> <td>Crash dumps</td> <td style="text-align:center"></td> <td style="text-align:center"></td> <td style="text-align:center">X</td> </tr> <tr> <td>Agent diagnostics logs</td> <td style="text-align:center"></td> <td style="text-align:center"></td> <td style="text-align:center">X</td> </tr> <tr> <td><b>Services and features supported</b></td> <td style="text-align:center"></td> <td style="text-align:center"></td> <td style="text-align:center"></td> </tr> <tr> <td>Microsoft Sentinel</td> <td style="text-align:center">X</td> <td style="text-align:center">X</td> <td style="text-align:center"></td> </tr> <tr> <td>VM Insights</td> <td style="text-align:center">X</td> <td style="text-align:center">X</td> <td style="text-align:center"></td> </tr> <tr> <td>Microsoft Defender for Cloud</td> <td style="text-align:center">X</td> <td style="text-align:center">X</td> <td style="text-align:center"></td> </tr> <tr> <td>Update Management</td> <td style="text-align:center">X</td> <td style="text-align:center">X</td> <td style="text-align:center"></td> </tr> <tr> <td>Change Tracking</td> <td style="text-align:center">X</td> <td style="text-align:center">X</td> <td style="text-align:center"></td> </tr> <tr> <td>SQL Best Practices Assessment</td> <td style="text-align:center">X</td> <td style="text-align:center"></td> <td style="text-align:center"></td> </tr> </table> <table id="custom" class="t-border"> <caption style="text-align:center"><b>For Linux machines</b></caption> <tr> <th></th> <th style="text-align:center">Azure Monitor Agent</th> <th style="text-align:center">Log Analytics Agent</th> <th style="text-align:center">Diagnostics extension (LAD)</th> </tr> <tr> <td><b>Data collected</b></td> <td style="text-align:center"></td> <td style="text-align:center"></td> <td style="text-align:center"></td> </tr> <tr> <td>Syslog</td> <td style="text-align:center">X</td> <td style="text-align:center">X</td> <td style="text-align:center">X</td> </tr> <tr> <td>Performance</td> <td style="text-align:center">X</td> <td style="text-align:center">X</td> <td style="text-align:center">X</td> </tr> <tr> <td><b>Services and features supported</b></td> <td style="text-align:center"></td> <td style="text-align:center"></td> <td style="text-align:center"></td> </tr> <tr> <td>Microsoft Sentinel</td> <td style="text-align:center">X</td> <td style="text-align:center">X</td> <td style="text-align:center"></td> </tr> <tr> <td>VM Insights</td> <td style="text-align:center">X</td> <td style="text-align:center">X</td> <td style="text-align:center"></td> </tr> <tr> <td>Microsoft Defender for Cloud</td> <td style="text-align:center">X</td> <td style="text-align:center">X</td> <td style="text-align:center"></td> </tr> <tr> <td>Update Management</td> <td style="text-align:center">X</td> <td style="text-align:center">X</td> <td style="text-align:center"></td> </tr> <tr> <td>Change Tracking</td> <td style="text-align:center">X</td> <td style="text-align:center">X</td> <td style="text-align:center"></td> </tr> <tr> <td>SQL Best Practices Assessment</td> <td style="text-align:center">X</td> <td style="text-align:center"></td> <td style="text-align:center"></td> </tr> </table> <h3 id="deployment-methods">Deployment methods</h3> <h4 id="policy">Policy</h4> <p>From my point of view, this is the prefered method <i>c.f.</i> my previous posts.</p> <h4 id="using-the-azure-portal">Using the Azure portal</h4> <p>There are multiple way to install the Log Analytics agent from the portal. I won’t get into the details of each method because this is well documented by Microsoft.</p> <table id="custom" class="t-border"> <caption style="text-align:center"><b>For Linux machines</b></caption> <tr> <th>Method</th> <th>URL</th> </tr> <tr> <td><a href="https://learn.microsoft.com/en-us/azure/automation/update-management/enable-from-portal" target="_blank" rel="noopener noreferrer">Azure portal - Bulk onboarding</a></td> <td>This method will also enable Update Management for monitoring</td> </tr> <tr> <td><a href="https://learn.microsoft.com/en-us/azure/automation/update-management/enable-from-vm" target="_blank" rel="noopener noreferrer">Azure portal - From a VM</a></td> <td>I don't recommend this method, see why at the end of the table.</td> </tr> <tr> <td><a href="https://learn.microsoft.com/en-us/azure/automation/update-management/enable-from-automation-account" target="_blank" rel="noopener noreferrer">Azure portal - From an Automation Account</a></td> <td>This method will also enable Update Management for monitoring</td> </tr> </table> <p><u>Note 1</u> : the <b>Azure portal - From a VM</b> has a side effect at the time I write this article. When clicking on the enable button, it will send a request to Azure and update the Log Analytics workspace, and remove all of its tags. I think the Javascript that builds the request in the portal is not properly coded, so I don’t use this method anymore.</p> <p><u>Note 2</u> : there are other ways to deploy Log Analytics agents on VMs, but they also enable other related services that we don’t need such as VM Insights.</p> <h4 id="extensions">Extensions</h4> <table id="custom" class="t-border"> <tr> <th>Method</th> <th>URL</th> </tr> <tr> <td><a href="https://learn.microsoft.com/en-us/azure/virtual-machines/extensions/oms-windows?toc=%2Fazure%2Fazure-monitor%2Ftoc.json" target="_blank" rel="noopener noreferrer">Windows</a></td> <td>Can be automated to deploy at scale</td> </tr> <tr> <td><a href="https://learn.microsoft.com/en-us/azure/virtual-machines/extensions/oms-linux?toc=%2Fazure%2Fazure-monitor%2Ftoc.json" target="_blank" rel="noopener noreferrer">Linux</a></td> <td>Can be automated to deploy at scale</td> </tr> </table> <h4 id="local-install">Local install</h4> <table id="custom" class="t-border"> <tr> <th>Method</th> <th>URL</th> </tr> <tr> <td><a href="https://learn.microsoft.com/en-us/azure/azure-monitor/agents/agent-windows?tabs=setup-wizard" target="_blank" rel="noopener noreferrer">Windows</a></td> <td>Connect on a machine to deploy the agent</td> </tr> <tr> <td><a href="https://learn.microsoft.com/en-us/azure/azure-monitor/agents/agent-linux?tabs=wrapper-script" target="_blank" rel="noopener noreferrer">Linux</a></td> <td>Connect on a machine to deploy the agent</td> </tr> </table> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2025 CyberIntruder - Molx32 . </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-MFVVRMM3DK"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-MFVVRMM3DK");</script> </body> </html>