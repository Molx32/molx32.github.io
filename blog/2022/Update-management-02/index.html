<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> CyberIntruder | Blog </title> <meta name="author" content="CyberIntruder - Molx32 "/> <meta name="description" content="This post is describes the architecture of the solution"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light"/> <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚛️</text></svg>"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://cyber-intruder.com/blog/2022/Update-management-02/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="https://cyber-intruder.com/">CyberIntruder</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/about">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/fr-fr/blog/2022/Update-management-02/"> FR-FR </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Azure Update Management - Part 3 - Deploy Azure ARC</h1> <p class="post-meta">August 2, 2022</p> <p class="post-tags"> <a href="/blog/2022"> <i class="fas fa-calendar fa-sm"></i> 2022 </a>   ·   <a href="/blog/tag/updatemanagement"> <i class="fas fa-hashtag fa-sm"></i> updatemanagement</a>   </p> </header> <article class="post-content"> <p><i>Hello there, the goal of this serie is to describe a real world implementation of <b>Azure Update Management</b>. This service was designed to update any machine in your infrastructure, whether they are hosted on Azure or elsewhere, provided your OSs are technically supported.</i></p> <p><i>In order for every reader to understand and find answers to their need, to I’ll try to give a comprehensive feedback from my experience, as well as sharing tips about design and architecture, automation, effectivement, troubleshooting issues, and so on!</i></p> <p><i>Have a nice reading.</i></p> <hr> <h4 id="plan">Plan</h4> <ul> <li><a href="/blog/2022/Update-management-00/">Part 0 - Introduction</a></li> <li><a href="/blog/2022/Update-management-01/">Part 1 - Architecture</a></li> <li><a href="/blog/2022/Update-management-011/">Part 2 - Azure Policy</a></li> <li><b><a href="/blog/2022/Update-management-02/">Part 3 - Azure ARC (you’re here)</a></b></li> <li><a href="/blog/2022/Update-management-03/">Part 4 - Log Analytics agents</a></li> <li><a href="/blog/2023/Update-management-04/">Part 5 - Automation accounts</a></li> <li><a href="/blog/2023/Update-management-05/">Part 6 - Monitoring</a></li> <li><a href="/blog/2023/Update-management-06/">Part 7 - Security patches on Azure ARC</a></li> <li><a href="/blog/2023/Update-management-07/">Part 8 - Security patches on CentOS machines</a></li> </ul> <hr> <h2 id="introduction">Introduction</h2> <p>In the previous post, I presented Azure policies that can be very useful for onboarding automation of the Log Analytics agent on both Azure and non Azure VMs. In this post, we will see how to deploy Azure ARC on all your non-Azure VMs.</p> <h2 id="general-consideration">General consideration</h2> <h3 id="prerequisites">Prerequisites</h3> <p>All the prerequisites are documented by Microsoft in their <a href="https://learn.microsoft.com/en-us/azure/azure-arc/servers/prerequisites" target="_blank" rel="noopener noreferrer">documentation</a>.</p> <h3 id="supported-os">Supported OS</h3> <p>Unfortunately, not all OSs are supported by Azure ARC. According to the Microsoft documentation, here are the supported OSs.</p> <ul> <li>Microsoft <ul> <li>Windows Server 2022</li> <li>Windows Server 2019</li> <li>Windows Server 2016</li> <li>Windows Server 2012 R2</li> <li>Windows Server 2008 R2 SP1</li> <li>Windows IoT Enterprise</li> <li>Azure Stack HCI</li> </ul> </li> <li>Linux <ul> <li>CentOS 7, 8</li> <li>Rocky Linux 8</li> <li>Oracle Linux 7, 8</li> <li>RHEL 7, 8, 9</li> <li>SLES 12, 15</li> <li>Ubuntu 16.04, 18.04, 20.04, 22.04 LTS</li> <li>Debian 10, 11</li> <li>Amazon Linux 2</li> </ul> </li> </ul> <h3 id="network-requirements">Network requirements</h3> <p>According to <a href="https://learn.microsoft.com/en-us/azure/azure-arc/servers/network-requirements?tabs=azure-cloud" target="_blank" rel="noopener noreferrer">Microsoft documentation</a>, there are several network flows to open. To achieve this, we can identify three cases :</p> <ol> <li>Your network devices are on Azure - In that case, you can leverage service tags in NSGs to open flows easily.</li> <li>If your network devices support domain-based filtering, you can configure them directly.</li> <li>Finally, if your network devices do not match the previous criteria, this means that you need to open flows based on IPs. In order to achieve this, you can <a href="https://www.microsoft.com/download/details.aspx?id=56519" target="_blank" rel="noopener noreferrer">download</a> the list of all IPs associated service tags. Here is a script that defines a list of needed service tags, that parses the Microsoft JSON file, and gives you a CSV with all IPs to whitelist. You can add automation to run this script every two weekd and interact with your network devices to update them directly with the appropriate IPs.</li> </ol> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">re</span>

<span class="k">def</span> <span class="nf">is_ipv4</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
    <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">regex</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>

<span class="n">tags</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sh">'</span><span class="s">GuestAndHybridManagement</span><span class="sh">'</span><span class="p">,</span>
    <span class="c1"># Storage
</span>    <span class="sh">'</span><span class="s">Storage.WestEurope</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">Storage.FranceCentral</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">Storage.FranceSouth</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">Storage.UKSouth</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">Storage.SouthCentralUS</span><span class="sh">'</span><span class="p">,</span>

    <span class="c1"># AzureMonitor 
</span>    <span class="sh">'</span><span class="s">AzureMonitor.WestEurope</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">AzureMonitor.FranceCentral</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">AzureMonitor.FranceSouth</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">AzureMonitor.UKSouth</span><span class="sh">'</span><span class="p">,</span>

    <span class="c1"># ServiceBus
</span>    <span class="sh">'</span><span class="s">ServiceBus.WestEurope</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">ServiceBus.FranceCentral</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">ServiceBus.FranceSouth</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">ServiceBus.UKSouth</span><span class="sh">'</span><span class="p">,</span>

    <span class="c1"># AzureResourceManager
</span>    <span class="sh">'</span><span class="s">AzureResourceManager</span><span class="sh">'</span><span class="p">,</span>

    <span class="c1"># AzureActiveDirectory
</span>    <span class="sh">'</span><span class="s">AzureActiveDirectory</span><span class="sh">'</span><span class="p">,</span>

    <span class="c1"># AzureArcInfrastructure
</span>    <span class="sh">'</span><span class="s">AzureArcInfrastructure.WestEurope</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">AzureArcInfrastructure.FranceCentral</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">AzureArcInfrastructure.FranceSouth</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">AzureArcInfrastructure.UKSouth</span><span class="sh">'</span><span class="p">,</span>

    <span class="c1"># AzureFrontDoor.FirstParty
</span>    <span class="sh">'</span><span class="s">AzureFrontDoor.FirstParty</span><span class="sh">'</span>
<span class="p">]</span>


<span class="n">f</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">ServiceTags_Public_20220808.json</span><span class="sh">'</span><span class="p">)</span>
<span class="n">csv</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">updtmgmt_ips.csv</span><span class="sh">'</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span>
<span class="n">csv</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sh">'</span><span class="s">tag,ip</span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">())</span>


<span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">values</span><span class="sh">'</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">tag</span><span class="p">[</span><span class="sh">'</span><span class="s">properties</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">addressPrefixes</span><span class="sh">'</span><span class="p">]:</span>
            <span class="c1"># Remove / if it is range
</span>            <span class="n">ip_to_test</span> <span class="o">=</span> <span class="n">ip</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">/</span><span class="sh">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nf">is_ipv4</span><span class="p">(</span><span class="n">ip_to_test</span><span class="p">):</span>
                <span class="n">csv</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span> <span class="o">+</span> <span class="sh">'</span><span class="s">,</span><span class="sh">'</span> <span class="o">+</span> <span class="n">ip</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
<span class="n">f</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
<span class="n">csv</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span></code></pre></figure> <h3 id="system-requirements">System requirements</h3> <p>For Windows systems :</p> <ul> <li>NET Framework 4.6 or later</li> <li>Windows PowerShell 4.0 or later</li> </ul> <p>For Linux systems :</p> <ul> <li>systemd</li> <li>wget</li> <li>openssl</li> <li>gnupg</li> </ul> <h3 id="azure-resource-providers">Azure resource providers</h3> <p>As you may know, all the different services that exist in Azure are provided by what is called <b>resource providers</b>. These can be regarded as modules that may or may not be enabled by default. In order for Azure ARC to work properly, we need to make sure these providers are enabled.</p> <ul> <li>Microsoft.HybridCompute</li> <li>Microsoft.GuestConfiguration</li> <li>Microsoft.HybridConnectivity</li> </ul> <p>You can use Azure Powershell or Azure CLI to enabled them.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="n">Connect-AzAccount</span><span class="w">
</span><span class="n">Set-AzContext</span><span class="w"> </span><span class="nt">-SubscriptionId</span><span class="w"> </span><span class="p">[</span><span class="n">subscription</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">want</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">onboard</span><span class="p">]</span><span class="w">
</span><span class="n">Register-AzResourceProvider</span><span class="w"> </span><span class="nt">-ProviderNamespace</span><span class="w"> </span><span class="nx">Microsoft.HybridCompute</span><span class="w">
</span><span class="n">Register-AzResourceProvider</span><span class="w"> </span><span class="nt">-ProviderNamespace</span><span class="w"> </span><span class="nx">Microsoft.GuestConfiguration</span><span class="w">
</span><span class="n">Register-AzResourceProvider</span><span class="w"> </span><span class="nt">-ProviderNamespace</span><span class="w"> </span><span class="nx">Microsoft.HybridConnectivity</span></code></pre></figure> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">az login
az account <span class="nb">set</span> <span class="nt">--subscription</span> <span class="s2">"{Your Subscription Name}"</span>
az provider register <span class="nt">--namespace</span> <span class="s1">'Microsoft.HybridCompute'</span>
az provider register <span class="nt">--namespace</span> <span class="s1">'Microsoft.GuestConfiguration'</span>
az provider register <span class="nt">--namespace</span> <span class="s1">'Microsoft.HybridConnectivity'</span></code></pre></figure> <h2 id="deployment">Deployment</h2> <h3 id="create-a-service-principal">Create a service principal</h3> <p>In order for the VMs to be onboarded, we need to use a service principal that will authenticate using a secret. This service principal need the <b>Azure Connected Machine Contributor</b> role on every subscription where you want to deploy Azure ARC machines. Here is the <a href="https://learn.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal" target="_blank" rel="noopener noreferrer">Microsoft documentation</a> that describes how to create a service principal from the portal.</p> <h3 id="set-up-deployment-script">Set up deployment script</h3> <p>When deploying from the portal, Microsoft provides a script to run on your servers. You need to specify a few arguments for this script :</p> <ul> <li> <b>Service principal client ID and secret</b> - From the service principal previously created</li> <li> <b>TenantId</b> - You can retrieve it from Azure AD</li> <li> <b>SubscriptionId</b> - This is the subscription where you will deploy Azure ARC machines.</li> <li> <b>ResourceGroup</b> - This is the resource group where you will deploy Azure ARC machines.</li> <li> <b>Location</b> - This is the Azure region (e.g. westeu) where the Azure ARC machines will be deployed.</li> <li> <b>Tags</b> - If you want to assign tags to your machines when deploying, use the <b>–tags</b> option and pass it key=value arguments e.g. “Datacenter=’02/21/2022 15:21:12’”.</li> </ul> <h3 id="run-the-scripts">Run the scripts</h3> <p>In order to run the scripts provided by Azure, you need to open flow to the following URLs. Unfortunately, the <i>aka.ms</i> URL are not predictable since the response you receive is an HTTP 302 Redirect that may change in the future.</p> <ul> <li>https://aka.ms/azcmagent-windows, which currently redirects to https://gbl.his.arc.azure.com</li> <li>https://aka.ms/AzureConnectedMachineAgent, which currently redirects to https://download.microsoft.com</li> <li>https://packages.microsoft.com/* For this reason, I’ll describe the procedure both with and without Internet access on the server, so that you can install it offiline, as I had to do.</li> </ul> <h4 id="deploy-with-internet-access">Deploy with Internet access</h4> <p>Depending whether the server is running Windows or Linux, run the following scripts. <u>Script for Windows</u></p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="kr">try</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="c"># Add the service principal application ID and secret here
</span><span class="w">
    </span><span class="nv">$servicePrincipalClientId</span><span class="o">=</span><span class="s2">"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"</span><span class="p">;</span><span class="w">
    </span><span class="nv">$servicePrincipalSecret</span><span class="o">=</span><span class="s2">"supersecret"</span><span class="p">;</span><span class="w">

    </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">SUBSCRIPTION_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy"</span><span class="p">;</span><span class="w">
    </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">RESOURCE_GROUP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"&lt;YOUR RESOURCE GROUP NAME&gt;"</span><span class="p">;</span><span class="w">
    </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">TENANT_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"zzzzzzzz-zzzz-zzzz-zzzz-zzzzzzzzzzzz"</span><span class="p">;</span><span class="w">
    </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">LOCATION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"&lt;YOUR REGION&gt;"</span><span class="p">;</span><span class="w">
    </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">AUTH_TYPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"principal"</span><span class="p">;</span><span class="w">
    </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">CORRELATION_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"6b777709-0403-4e37-b05c-da346249ffaf"</span><span class="p">;</span><span class="w">
    </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">CLOUD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"AzureCloud"</span><span class="p">;</span><span class="w">

    </span><span class="p">[</span><span class="n">Net.ServicePointManager</span><span class="p">]::</span><span class="n">SecurityProtocol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Net.ServicePointManager</span><span class="p">]::</span><span class="n">SecurityProtocol</span><span class="w"> </span><span class="o">-bor</span><span class="w"> </span><span class="nx">3072</span><span class="p">;</span><span class="w">

    </span><span class="c"># Download the installation package
</span><span class="w">
    </span><span class="n">Invoke-WebRequest</span><span class="w"> </span><span class="nt">-UseBasicParsing</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="s2">"https://aka.ms/azcmagent-windows"</span><span class="w"> </span><span class="nt">-TimeoutSec</span><span class="w"> </span><span class="nx">30</span><span class="w"> </span><span class="nt">-OutFile</span><span class="w"> </span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">TEMP</span><span class="s2">\install_windows_azcmagent.ps1"</span><span class="p">;</span><span class="w">

    </span><span class="c"># Install the hybrid agent
</span><span class="w">
    </span><span class="o">&amp;</span><span class="w"> </span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">TEMP</span><span class="s2">\install_windows_azcmagent.ps1"</span><span class="p">;</span><span class="w">
    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$LASTEXITCODE</span><span class="w"> </span><span class="o">-ne</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">exit</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w">

    </span><span class="c"># Run connect command
</span><span class="w">
    </span><span class="o">&amp;</span><span class="w"> </span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">ProgramW6432</span><span class="s2">\AzureConnectedMachineAgent\azcmagent.exe"</span><span class="w"> </span><span class="n">connect</span><span class="w"> </span><span class="nt">--service-principal-id</span><span class="w"> </span><span class="s2">"</span><span class="nv">$servicePrincipalClientId</span><span class="s2">"</span><span class="w"> </span><span class="nt">--service-principal-secret</span><span class="w"> </span><span class="s2">"</span><span class="nv">$servicePrincipalSecret</span><span class="s2">"</span><span class="w"> </span><span class="nt">--resource-group</span><span class="w"> </span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">RESOURCE_GROUP</span><span class="s2">"</span><span class="w"> </span><span class="nt">--tenant-id</span><span class="w"> </span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">TENANT_ID</span><span class="s2">"</span><span class="w"> </span><span class="nt">--location</span><span class="w"> </span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">LOCATION</span><span class="s2">"</span><span class="w"> </span><span class="nt">--subscription-id</span><span class="w"> </span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">SUBSCRIPTION_ID</span><span class="s2">"</span><span class="w"> </span><span class="nt">--cloud</span><span class="w"> </span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">CLOUD</span><span class="s2">"</span><span class="w"> </span><span class="nt">--correlation-id</span><span class="w"> </span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">CORRELATION_ID</span><span class="s2">"</span><span class="w"> </span><span class="nt">--tags</span><span class="w"> </span><span class="s2">"Datacenter='02/21/2022 15:21:12'"</span><span class="p">;</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="kr">catch</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$logBody</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="nx">subscriptionId</span><span class="o">=</span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">SUBSCRIPTION_ID</span><span class="s2">"</span><span class="p">;</span><span class="nx">resourceGroup</span><span class="o">=</span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">RESOURCE_GROUP</span><span class="s2">"</span><span class="p">;</span><span class="nx">tenantId</span><span class="o">=</span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">TENANT_ID</span><span class="s2">"</span><span class="p">;</span><span class="nx">location</span><span class="o">=</span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">LOCATION</span><span class="s2">"</span><span class="p">;</span><span class="nx">correlationId</span><span class="o">=</span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">CORRELATION_ID</span><span class="s2">"</span><span class="p">;</span><span class="nx">authType</span><span class="o">=</span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">AUTH_TYPE</span><span class="s2">"</span><span class="p">;</span><span class="nx">operation</span><span class="o">=</span><span class="s2">"onboarding"</span><span class="p">;</span><span class="nx">messageType</span><span class="o">=</span><span class="bp">$_</span><span class="err">.</span><span class="nx">FullyQualifiedErrorId</span><span class="p">;</span><span class="nx">message</span><span class="o">=</span><span class="s2">"</span><span class="bp">$_</span><span class="s2">"</span><span class="p">;};</span><span class="w">
    </span><span class="n">Invoke-WebRequest</span><span class="w"> </span><span class="nt">-UseBasicParsing</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="s2">"https://gbl.his.arc.azure.com/log"</span><span class="w"> </span><span class="nt">-Method</span><span class="w"> </span><span class="s2">"PUT"</span><span class="w"> </span><span class="nt">-Body</span><span class="w"> </span><span class="p">(</span><span class="nv">$logBody</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ConvertTo-Json</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">out-null</span><span class="p">;</span><span class="w">
    </span><span class="n">Write-Host</span><span class="w">  </span><span class="nt">-ForegroundColor</span><span class="w"> </span><span class="nx">red</span><span class="w"> </span><span class="bp">$_</span><span class="o">.</span><span class="nf">Exception</span><span class="p">;</span><span class="w">
</span><span class="p">}</span></code></pre></figure> <p><u>Script for Linux</u></p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Add the service principal application ID and secret here
</span>
<span class="nv">servicePrincipalClientId</span><span class="o">=</span><span class="s2">"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"</span><span class="p">;</span>
<span class="nv">servicePrincipalSecret</span><span class="o">=</span><span class="s2">"supersecret"</span><span class="p">;</span>


<span class="nb">export </span><span class="nv">subscriptionId</span><span class="o">=</span><span class="s2">"yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy"</span><span class="p">;</span>
<span class="nb">export </span><span class="nv">resourceGroup</span><span class="o">=</span><span class="s2">"&lt;YOUR RESOURCE GROUP NAME&gt;"</span><span class="p">;</span>
<span class="nb">export </span><span class="nv">tenantId</span><span class="o">=</span><span class="s2">"zzzzzzzz-zzzz-zzzz-zzzz-zzzzzzzzzzzz"</span><span class="p">;</span>
<span class="nb">export </span><span class="nv">location</span><span class="o">=</span><span class="s2">"&lt;YOUR REGION&gt;"</span><span class="p">;</span>
<span class="nb">export </span><span class="nv">authType</span><span class="o">=</span><span class="s2">"principal"</span><span class="p">;</span>
<span class="nb">export </span><span class="nv">correlationId</span><span class="o">=</span><span class="s2">"6b777709-0403-4e37-b05c-da346249ffaf"</span><span class="p">;</span>
<span class="nb">export </span><span class="nv">cloud</span><span class="o">=</span><span class="s2">"AzureCloud"</span><span class="p">;</span>

<span class="c"># Download the installation package
</span>
<span class="nv">output</span><span class="o">=</span><span class="si">$(</span>wget https://aka.ms/azcmagent <span class="nt">-O</span> ~/install_linux_azcmagent.sh 2&gt;&amp;1<span class="si">)</span><span class="p">;</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> <span class="o">!=</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then </span>wget <span class="nt">-qO-</span> <span class="nt">--method</span><span class="o">=</span>PUT <span class="nt">--body-data</span><span class="o">=</span><span class="s2">"{</span><span class="se">\"</span><span class="s2">subscriptionId</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="nv">$subscriptionId</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">resourceGroup</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="nv">$resourceGroup</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">tenantId</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="nv">$tenantId</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">location</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="nv">$location</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">correlationId</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="nv">$correlationId</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">authType</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="nv">$authType</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">operation</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">onboarding</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">messageType</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">DownloadScriptFailed</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">message</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="nv">$output</span><span class="se">\"</span><span class="s2">}"</span> <span class="s2">"https://gbl.his.arc.azure.com/log"</span> &amp;&gt; /dev/null <span class="o">||</span> <span class="nb">true</span><span class="p">;</span> <span class="k">fi</span><span class="p">;</span>
<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$output</span><span class="s2">"</span><span class="p">;</span>

<span class="c"># Install the hybrid agent
</span>
bash ~/install_linux_azcmagent.sh<span class="p">;</span>

<span class="c"># Run connect command
</span>
<span class="nb">sudo </span>azcmagent connect <span class="nt">--service-principal-id</span> <span class="s2">"</span><span class="nv">$servicePrincipalClientId</span><span class="s2">"</span> <span class="nt">--service-principal-secret</span> <span class="s2">"</span><span class="nv">$servicePrincipalSecret</span><span class="s2">"</span> <span class="nt">--resource-group</span> <span class="s2">"</span><span class="nv">$resourceGroup</span><span class="s2">"</span> <span class="nt">--tenant-id</span> <span class="s2">"</span><span class="nv">$tenantId</span><span class="s2">"</span> <span class="nt">--location</span> <span class="s2">"</span><span class="nv">$location</span><span class="s2">"</span> <span class="nt">--subscription-id</span> <span class="s2">"</span><span class="nv">$subscriptionId</span><span class="s2">"</span> <span class="nt">--cloud</span> <span class="s2">"</span><span class="nv">$cloud</span><span class="s2">"</span> <span class="nt">--tags</span> <span class="s2">"Datacenter='02/21/2022 15:21:12'"</span> <span class="nt">--correlation-id</span> <span class="s2">"</span><span class="nv">$correlationId</span><span class="s2">"</span><span class="p">;</span></code></pre></figure> <h4 id="deploy-without-internet-access">Deploy without Internet access</h4> <h5 id="install-azcmagent">Install azcmagent</h5> <p>The first step for Windows machines is to <a href="https://aka.ms/AzureConnectedMachineAgent" target="_blank" rel="noopener noreferrer">download the AzureConnectedMachineAgent MSI file</a> from a machine that has Internet. Then you can push it to your machines and install it using the Microsoft script I adapted for offline install, <a href="https://github.com/Molx32/AzureUpdateManagement/blob/main/install_windows_azcmagent.ps1" target="_blank" rel="noopener noreferrer">available on my Github</a>, that you must run in the directory where the MSI file is located.</p> <p>The first step for Linux machines is to download the AzureConnectedMachineAgent .deb or .rpm files based on your OS. You can retrieve them at https://packages.microsoft.com. Here are some examples :</p> <ul> <li>For CentOS : https://packages.microsoft.com/centos/8/prod/Packages/a/azcmagent-1.9.21208-007.x86_64.rpm</li> <li>For Debian : https://packages.microsoft.com/debian/10/prod/pool/main/a/azcmagent/azcmagent_1.26.02210.615_amd64.deb</li> <li>For Ubuntu : https://packages.microsoft.com/ubuntu/20.04/prod/pool/main/a/azcmagent/azcmagent_1.26.02210.615_amd64.deb Then you can push it to your machines and install it using the Microsoft script I adapted for offline install, <a href="https://github.com/Molx32/AzureUpdateManagement/blob/main/install_linux_azcmagent.sh" target="_blank" rel="noopener noreferrer">available on my Github</a>, that you must run in the directory where the MSI file is located. <u>Note</u>: you can tweak the script to change the version number of azcmagent :</li> </ul> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Install the azcmagent
</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$apt</span> <span class="nt">-eq</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
	</span><span class="nb">sudo</span> <span class="nt">-E</span> apt <span class="nb">install</span> <span class="nt">-y</span> ./packages/azcmagent_1.17.01931.118_amd64.deb
<span class="k">elif</span> <span class="o">[</span> <span class="nv">$zypper</span> <span class="nt">-eq</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
	</span><span class="nb">sudo</span> <span class="nt">-E</span> zypper <span class="nb">install</span> <span class="nt">-y</span> ./packages/azcmagent-1.17.01931-135.x86_64.rpm
<span class="k">else
    </span><span class="nb">sudo</span> <span class="nt">-E</span> yum <span class="nt">-y</span> localinstall ./packages/azcmagent-1.17.01931-135.x86_64.rpm
<span class="k">fi</span></code></pre></figure> <h5 id="deploy-azure-arc">Deploy Azure ARC</h5> <p>Once the machine is deployed, all you need to do is to run the azcmagent command as shown below. <u>For Windows machines</u></p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="kr">try</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="c"># Add the service principal application ID and secret here
</span><span class="w">
    </span><span class="nv">$servicePrincipalClientId</span><span class="o">=</span><span class="s2">"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"</span><span class="p">;</span><span class="w">
    </span><span class="nv">$servicePrincipalSecret</span><span class="o">=</span><span class="s2">"supersecret"</span><span class="p">;</span><span class="w">

    </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">SUBSCRIPTION_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy"</span><span class="p">;</span><span class="w">
    </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">RESOURCE_GROUP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"&lt;YOUR RESOURCE GROUP NAME&gt;"</span><span class="p">;</span><span class="w">
    </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">TENANT_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"zzzzzzzz-zzzz-zzzz-zzzz-zzzzzzzzzzzz"</span><span class="p">;</span><span class="w">
    </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">LOCATION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"&lt;YOUR REGION&gt;"</span><span class="p">;</span><span class="w">
    </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">AUTH_TYPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"principal"</span><span class="p">;</span><span class="w">
    </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">CORRELATION_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"6b777709-0403-4e37-b05c-da346249ffaf"</span><span class="p">;</span><span class="w">
    </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">CLOUD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"AzureCloud"</span><span class="p">;</span><span class="w">

    </span><span class="p">[</span><span class="n">Net.ServicePointManager</span><span class="p">]::</span><span class="n">SecurityProtocol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Net.ServicePointManager</span><span class="p">]::</span><span class="n">SecurityProtocol</span><span class="w"> </span><span class="o">-bor</span><span class="w"> </span><span class="nx">3072</span><span class="p">;</span><span class="w">

    </span><span class="c"># Run connect command
</span><span class="w">
    </span><span class="o">&amp;</span><span class="w"> </span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">ProgramW6432</span><span class="s2">\AzureConnectedMachineAgent\azcmagent.exe"</span><span class="w"> </span><span class="n">connect</span><span class="w"> </span><span class="nt">--service-principal-id</span><span class="w"> </span><span class="s2">"</span><span class="nv">$servicePrincipalClientId</span><span class="s2">"</span><span class="w"> </span><span class="nt">--service-principal-secret</span><span class="w"> </span><span class="s2">"</span><span class="nv">$servicePrincipalSecret</span><span class="s2">"</span><span class="w"> </span><span class="nt">--resource-group</span><span class="w"> </span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">RESOURCE_GROUP</span><span class="s2">"</span><span class="w"> </span><span class="nt">--tenant-id</span><span class="w"> </span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">TENANT_ID</span><span class="s2">"</span><span class="w"> </span><span class="nt">--location</span><span class="w"> </span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">LOCATION</span><span class="s2">"</span><span class="w"> </span><span class="nt">--subscription-id</span><span class="w"> </span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">SUBSCRIPTION_ID</span><span class="s2">"</span><span class="w"> </span><span class="nt">--cloud</span><span class="w"> </span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">CLOUD</span><span class="s2">"</span><span class="w"> </span><span class="nt">--correlation-id</span><span class="w"> </span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">CORRELATION_ID</span><span class="s2">"</span><span class="w"> </span><span class="nt">--tags</span><span class="w"> </span><span class="s2">"Datacenter='02/21/2022 15:21:12'"</span><span class="p">;</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="kr">catch</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$logBody</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="nx">subscriptionId</span><span class="o">=</span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">SUBSCRIPTION_ID</span><span class="s2">"</span><span class="p">;</span><span class="nx">resourceGroup</span><span class="o">=</span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">RESOURCE_GROUP</span><span class="s2">"</span><span class="p">;</span><span class="nx">tenantId</span><span class="o">=</span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">TENANT_ID</span><span class="s2">"</span><span class="p">;</span><span class="nx">location</span><span class="o">=</span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">LOCATION</span><span class="s2">"</span><span class="p">;</span><span class="nx">correlationId</span><span class="o">=</span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">CORRELATION_ID</span><span class="s2">"</span><span class="p">;</span><span class="nx">authType</span><span class="o">=</span><span class="s2">"</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">AUTH_TYPE</span><span class="s2">"</span><span class="p">;</span><span class="nx">operation</span><span class="o">=</span><span class="s2">"onboarding"</span><span class="p">;</span><span class="nx">messageType</span><span class="o">=</span><span class="bp">$_</span><span class="err">.</span><span class="nx">FullyQualifiedErrorId</span><span class="p">;</span><span class="nx">message</span><span class="o">=</span><span class="s2">"</span><span class="bp">$_</span><span class="s2">"</span><span class="p">;};</span><span class="w">
    </span><span class="n">Invoke-WebRequest</span><span class="w"> </span><span class="nt">-UseBasicParsing</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="s2">"https://gbl.his.arc.azure.com/log"</span><span class="w"> </span><span class="nt">-Method</span><span class="w"> </span><span class="s2">"PUT"</span><span class="w"> </span><span class="nt">-Body</span><span class="w"> </span><span class="p">(</span><span class="nv">$logBody</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ConvertTo-Json</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">out-null</span><span class="p">;</span><span class="w">
    </span><span class="n">Write-Host</span><span class="w">  </span><span class="nt">-ForegroundColor</span><span class="w"> </span><span class="nx">red</span><span class="w"> </span><span class="bp">$_</span><span class="o">.</span><span class="nf">Exception</span><span class="p">;</span><span class="w">
</span><span class="p">}</span></code></pre></figure> <p><u>For Linux machines</u></p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Add the service principal application ID and secret here
</span>
<span class="nv">servicePrincipalClientId</span><span class="o">=</span><span class="s2">"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"</span><span class="p">;</span>
<span class="nv">servicePrincipalSecret</span><span class="o">=</span><span class="s2">"supersecret"</span><span class="p">;</span>


<span class="nb">export </span><span class="nv">subscriptionId</span><span class="o">=</span><span class="s2">"yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy"</span><span class="p">;</span>
<span class="nb">export </span><span class="nv">resourceGroup</span><span class="o">=</span><span class="s2">"&lt;YOUR RESOURCE GROUP NAME&gt;"</span><span class="p">;</span>
<span class="nb">export </span><span class="nv">tenantId</span><span class="o">=</span><span class="s2">"zzzzzzzz-zzzz-zzzz-zzzz-zzzzzzzzzzzz"</span><span class="p">;</span>
<span class="nb">export </span><span class="nv">location</span><span class="o">=</span><span class="s2">"&lt;YOUR REGION&gt;"</span><span class="p">;</span>
<span class="nb">export </span><span class="nv">authType</span><span class="o">=</span><span class="s2">"principal"</span><span class="p">;</span>
<span class="nb">export </span><span class="nv">correlationId</span><span class="o">=</span><span class="s2">"6b777709-0403-4e37-b05c-da346249ffaf"</span><span class="p">;</span>
<span class="nb">export </span><span class="nv">cloud</span><span class="o">=</span><span class="s2">"AzureCloud"</span><span class="p">;</span>

<span class="c"># Run connect command
</span>
<span class="nb">sudo </span>azcmagent connect <span class="nt">--service-principal-id</span> <span class="s2">"</span><span class="nv">$servicePrincipalClientId</span><span class="s2">"</span> <span class="nt">--service-principal-secret</span> <span class="s2">"</span><span class="nv">$servicePrincipalSecret</span><span class="s2">"</span> <span class="nt">--resource-group</span> <span class="s2">"</span><span class="nv">$resourceGroup</span><span class="s2">"</span> <span class="nt">--tenant-id</span> <span class="s2">"</span><span class="nv">$tenantId</span><span class="s2">"</span> <span class="nt">--location</span> <span class="s2">"</span><span class="nv">$location</span><span class="s2">"</span> <span class="nt">--subscription-id</span> <span class="s2">"</span><span class="nv">$subscriptionId</span><span class="s2">"</span> <span class="nt">--cloud</span> <span class="s2">"</span><span class="nv">$cloud</span><span class="s2">"</span> <span class="nt">--tags</span> <span class="s2">"Datacenter='02/21/2022 15:21:12'"</span> <span class="nt">--correlation-id</span> <span class="s2">"</span><span class="nv">$correlationId</span><span class="s2">"</span><span class="p">;</span></code></pre></figure> <h2 id="validation">Validation</h2> <p>You can ensure Azure ARC is deployed by taking a look at the Azure portal.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/azure_arc_01-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/azure_arc_01-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/azure_arc_01-1400.webp"></source> <img src="/assets/img/azure_arc_01.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2025 CyberIntruder - Molx32 . </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-MFVVRMM3DK"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-MFVVRMM3DK");</script> </body> </html>