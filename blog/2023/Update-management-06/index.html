<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> CyberIntruder | Blog </title> <meta name="author" content="CyberIntruder - Molx32 "/> <meta name="description" content="This post is describes the architecture of the solution"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light"/> <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚛️</text></svg>"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://cyber-intruder.com/blog/2023/Update-management-06/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="https://cyber-intruder.com/">CyberIntruder</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/about">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/fr-fr/blog/2023/Update-management-06/"> FR-FR </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Azure Update Management - Part 7 - Security patches on Azure ARC!</h1> <p class="post-meta">February 16, 2023</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/updatemanagement"> <i class="fas fa-hashtag fa-sm"></i> updatemanagement</a>   </p> </header> <article class="post-content"> <p><i>Hello there, the goal of this serie is to describe a real world implementation of <b>Azure Update Management</b>. This service was designed to update any machine in your infrastructure, whether they are hosted on Azure or elsewhere, provided your OSs are technically supported.</i></p> <p><i>In order for every reader to understand and find answers to their need, to I’ll try to give a comprehensive feedback from my experience, as well as sharing tips about design and architecture, automation, effectivement, troubleshooting issues, and so on!</i></p> <p><i>Have a nice reading.</i></p> <hr> <h4 id="plan">Plan</h4> <ul> <li><a href="/blog/2022/Update-management-00/">Part 0 - Introduction</a></li> <li><a href="/blog/2022/Update-management-01/">Part 1 - Architecture</a></li> <li><a href="/blog/2022/Update-management-011/">Part 2 - Azure Policy</a></li> <li><a href="/blog/2022/Update-management-02/">Part 3 - Azure ARC</a></li> <li><a href="/blog/2022/Update-management-03/">Part 4 - Log Analytics agents</a></li> <li><a href="/blog/2023/Update-management-04/">Part 5 - Automation accounts</a></li> <li><a href="/blog/2023/Update-management-05/">Part 6 - Monitoring</a></li> <li><b><a href="/blog/2023/Update-management-06/">Part 7 - Security patches on Azure ARC (you’re here)</a></b></li> <li><a href="/blog/2023/Update-management-07/">Part 8 - Security patches on CentOS machines</a></li> </ul> <hr> <h2 id="introduction">Introduction</h2> <p>So what’s wrong with Azure ARC? We saw many things in the previous posts, but what we did not see is how to integrate Azure ARC VMs on dynamic patches using tags. Let’s go!</p> <h2 id="context">Context</h2> <p>So, what’s wrong with Azure ARC? Let’s compare dynamic onboarding between Azure VMs and Azure ARC VMs.</p> <h5 id="dynamic-onboarding-for-azure-vm">Dynamic onboarding for Azure VM</h5> <p>In that case, as the image shows, we can define up to four criteria on which the deployment schedule will rely to onboard VMs at patching time. Unfortunately, this is only available for Azure VMs.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/patch_arc_1-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/patch_arc_1-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/patch_arc_1-1400.webp"></source> <img src="/assets/img/patch_arc_1.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <h5 id="dynamic-onboarding-for-azure-arc-vm">Dynamic onboarding for Azure ARC VM</h5> <p>As you can see here, Azure ARC VMs can’t be onboarded using the same four criteria. Instead, we need to configure a <b>saved search</b>, which is a simple KQL query saved within the Log Analytics workspace attached to our Automation Account.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/patch_arc_2-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/patch_arc_2-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/patch_arc_2-1400.webp"></source> <img src="/assets/img/patch_arc_2.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>If we take a look at the queries <a href="https://learn.microsoft.com/en-us/azure/automation/update-management/configure-groups#define-dynamic-groups-for-non-azure-machines" target="_blank" rel="noopener noreferrer">Microsoft documentation</a>, we can see that saved searches, also known as <b>computer groups</b> rely on tables such as <i>Heartbeat</i>, or <i>Update</i>. The following example shows a request that returns all computers that have the <b>srv</b> string in their name. So this would be interesting to filter on the computer tag rather then its name… but <u>this is not possible : we can’t find any tag column in any table</u> of the Log Analytics workspace. <b>This is what’s wrong this Azure ARC VMs</b>.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Heartbeat
| where Computer contains "srv"
| distinct Computer
</code></pre></div></div> <p>The next section describe our workaround to still dynamically onboard those Azure ARC VMs dynamically, based on their tags.</p> <hr> <h2 id="the-insane-workaround">The insane workaround!</h2> <p>The basic intent is very simple : automate the process of assigning an Azure ARC VM to a deployment schedule. To do it manually, go on a deployment schedule, click on <b>Machines to update</b>, look for the machines to onboard, click on them and save.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/patch_arc_3-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/patch_arc_3-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/patch_arc_3-1400.webp"></source> <img src="/assets/img/patch_arc_3.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/patch_arc_4-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/patch_arc_4-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/patch_arc_4-1400.webp"></source> <img src="/assets/img/patch_arc_4.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <h3 id="script-logic">Script logic</h3> <p>The script in run every day between 15:00 and 18:00, week ends included. When a tag is changed on a VMs, schedules will be updated after the script run. There is one script per CSP resource group as shown on the scheme below.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/patch_arc_5-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/patch_arc_5-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/patch_arc_5-1400.webp"></source> <img src="/assets/img/patch_arc_5.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <h4 id="step-0">Step 0</h4> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">#!/usr/bin/env python3
</span><span class="kn">from</span> <span class="n">azure.identity</span> <span class="kn">import</span> <span class="n">DefaultAzureCredential</span>
<span class="kn">from</span> <span class="n">azure.mgmt.automation</span> <span class="kn">import</span> <span class="n">AutomationClient</span>
<span class="kn">from</span> <span class="n">azure.mgmt.automation.models</span> <span class="kn">import</span> <span class="n">NonAzureQueryProperties</span>
<span class="kn">from</span> <span class="n">azure.mgmt.hybridcompute</span> <span class="kn">import</span> <span class="n">HybridComputeManagementClient</span>
<span class="kn">from</span> <span class="n">azure.mgmt.loganalytics</span> <span class="kn">import</span> <span class="n">LogAnalyticsManagementClient</span>
<span class="kn">from</span> <span class="n">azure.loganalytics</span> <span class="kn">import</span> <span class="n">LogAnalyticsDataClient</span>
<span class="kn">from</span> <span class="n">azure.loganalytics.models</span> <span class="kn">import</span> <span class="n">QueryBody</span>
<span class="kn">from</span> <span class="n">azure.monitor.query</span> <span class="kn">import</span> <span class="n">LogsQueryClient</span><span class="p">,</span> <span class="n">LogsQueryStatus</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="n">automationassets</span>
<span class="kn">from</span> <span class="n">automationassets</span> <span class="kn">import</span> <span class="n">AutomationAssetNotFound</span>
<span class="kn">from</span> <span class="n">azure.core.exceptions</span> <span class="kn">import</span> <span class="n">HttpResponseError</span>

<span class="c1"># Handle query output
</span><span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>

<span class="c1"># System lib
</span><span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">random</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">os</span>

<span class="c1"># Retrieve all variable that are set in our automation account
</span><span class="n">automation_account_name</span> <span class="o">=</span> <span class="n">automationassets</span><span class="p">.</span><span class="nf">get_automation_variable</span><span class="p">(</span><span class="sh">"</span><span class="s">aa_name</span><span class="sh">"</span><span class="p">)</span>
<span class="n">resource_group_name</span> <span class="o">=</span> <span class="n">automationassets</span><span class="p">.</span><span class="nf">get_automation_variable</span><span class="p">(</span><span class="sh">"</span><span class="s">resource_group_name</span><span class="sh">"</span><span class="p">)</span>
<span class="n">subscription_id</span> <span class="o">=</span> <span class="n">automationassets</span><span class="p">.</span><span class="nf">get_automation_variable</span><span class="p">(</span><span class="sh">"</span><span class="s">subscription_id</span><span class="sh">"</span><span class="p">)</span>
<span class="n">saved_searche_id</span> <span class="o">=</span> <span class="n">automationassets</span><span class="p">.</span><span class="nf">get_automation_variable</span><span class="p">(</span><span class="sh">"</span><span class="s">saved_search_name</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Authenticate
# This function will use the automation account identity to get an authentication token.
# This token will then be used to access all the APIs we need.
</span><span class="n">token_credential</span> <span class="o">=</span> <span class="nc">DefaultAzureCredential</span><span class="p">()</span>

<span class="c1"># Instanciate clients
# In order to communicate with the different APIs, it is necessary to instanciate clients.
#   - The 'AutomationClient' will be used to get and update deployment schedules
#   - The 'LogAnalyticsManagementClient' will be used to get the Log Analytics that is associated to our Automation Account
#   - The 'HybridComputeManagementClient' will be used to get and modify Azure ARC VMs
#   - The 'LogsQueryClient' will be used to send KQL queries to the Log Analytics workspace and fetch results
</span><span class="n">automation_client</span> <span class="o">=</span> <span class="nc">AutomationClient</span><span class="p">(</span><span class="n">token_credential</span><span class="p">,</span> <span class="n">subscription_id</span><span class="p">)</span>
<span class="n">log_analytics_client</span> <span class="o">=</span> <span class="nc">LogAnalyticsManagementClient</span><span class="p">(</span><span class="n">token_credential</span><span class="p">,</span> <span class="n">subscription_id</span><span class="p">)</span>
<span class="n">azure_arc_client</span> <span class="o">=</span> <span class="nc">HybridComputeManagementClient</span><span class="p">(</span><span class="n">token_credential</span><span class="p">,</span> <span class="n">subscription_id</span><span class="p">)</span>
<span class="n">log_analytics_data_client</span> <span class="o">=</span> <span class="nc">LogsQueryClient</span><span class="p">(</span><span class="n">token_credential</span><span class="p">)</span></code></pre></figure> <h4 id="step-1">Step 1</h4> <p>In this next step, we want to make sure that each machine that we handle is actually connected to Azure, otherwise this will generate errors or unexpected behaviors. To achieve this, we send a request to the Log Analytics workspace that collects all the Heartbeats.</p> <p>Then, for each connected machine, we must retrieve its tag. Since the Heartbeat table doesn’t return tags, we look for them in the Azure ARC service.</p> <ol> <li>Query Log Analytics workspace to get VMs connected to Azure</li> <li>For each connected machine <ul> <li>Get its tags using the Azure ARC API</li> </ul> </li> </ol> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">### 1. GET ALL CONNECTED MACHINES ###
# This block of code is used to retrieve the Log Analytics workspace ID. This ID will be used to send
# the KQL query below to the Log Analytics workspace.
</span><span class="n">query</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Heartbeat | distinct Computer, ResourceGroup, OSType, Resource</span><span class="sh">"</span>
<span class="n">workspace_resource_id</span> <span class="o">=</span> <span class="n">automation_client</span><span class="p">.</span><span class="n">linked_workspace</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">resource_group_name</span><span class="p">,</span> <span class="n">automation_account_name</span><span class="p">).</span><span class="nb">id</span>
<span class="n">workspace_name</span> <span class="o">=</span> <span class="n">automation_client</span><span class="p">.</span><span class="n">linked_workspace</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">resource_group_name</span><span class="p">,</span> <span class="n">automation_account_name</span><span class="p">).</span><span class="nb">id</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">/</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">workspace_id</span> <span class="o">=</span> <span class="n">log_analytics_client</span><span class="p">.</span><span class="n">workspaces</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">resource_group_name</span><span class="p">,</span> <span class="n">workspace_name</span><span class="p">).</span><span class="n">customer_id</span>
<span class="n">workspace</span> <span class="o">=</span> <span class="n">automation_client</span><span class="p">.</span><span class="n">linked_workspace</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">resource_group_name</span><span class="p">,</span> <span class="n">automation_account_name</span><span class="p">)</span>

<span class="c1"># The following block of code will send the KQL query to the Log Analytics workspace. We pass a 'timespan' parameter in the query
# to tell the Log Analytics workspace that we only want to make the query on the last 24 hours (1 day) of data.
</span><span class="n">end_time</span><span class="o">=</span><span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">(</span><span class="n">timezone</span><span class="p">.</span><span class="n">utc</span><span class="p">)</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="nf">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">log_analytics_data_client</span><span class="p">.</span><span class="nf">query_workspace</span><span class="p">(</span><span class="n">workspace_id</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">timespan</span><span class="o">=</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">))</span>

<span class="c1"># Block of code to handle the result of the query that is store in the 'data' variable.
</span><span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">LogsQueryStatus</span><span class="p">.</span><span class="n">PARTIAL</span><span class="p">:</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">partial_error</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">partial_data</span>
	<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Failed to retrieve connected machines</span><span class="sh">"</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">LogsQueryStatus</span><span class="p">.</span><span class="n">SUCCESS</span><span class="p">:</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">tables</span>

<span class="c1">### 2. RETRIEVE TAG FOR EACH CONNECTED MACHINE ###
# In this next block of code, we iterate over all our connected machine, and we make a request to the Azure ARC to get the VM tags.
# Once all the data is retrieved, it is added to a list of dictionnaries named 'connected_machines'.
</span><span class="n">connected_machines</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
	<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">table</span><span class="p">.</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">table</span><span class="p">.</span><span class="n">columns</span><span class="p">)</span>
	<span class="c1"># print(df)
</span>	<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="p">.</span><span class="nf">iterrows</span><span class="p">():</span>
		<span class="c1"># Local vars
</span>		<span class="n">machine_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="n">machine_rg</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
		<span class="n">machine_os</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
		<span class="n">machine_resource</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
		<span class="n">machine_tag</span> <span class="o">=</span> <span class="sh">""</span>

		<span class="c1"># Get tag using Azure ARC API
</span>		<span class="k">try</span><span class="p">:</span>
			<span class="n">arc_vm</span> <span class="o">=</span> <span class="n">azure_arc_client</span><span class="p">.</span><span class="n">machines</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">machine_rg</span><span class="p">,</span> <span class="n">machine_resource</span><span class="p">)</span>
			<span class="n">machine_tag</span> <span class="o">=</span> <span class="n">arc_vm</span><span class="p">.</span><span class="n">tags</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">patch</span><span class="sh">'</span><span class="p">)</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="nf">print</span><span class="p">(</span><span class="n">machine_resource</span><span class="p">)</span>
			<span class="nf">print</span><span class="p">(</span><span class="n">machine_rg</span><span class="p">)</span>
			<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">|---- Machine </span><span class="sh">"</span> <span class="o">+</span> <span class="n">machine_name</span> <span class="o">+</span> <span class="sh">"</span><span class="s"> not found in Azure ARC</span><span class="sh">"</span><span class="p">)</span>

		<span class="n">dic</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">Computer</span><span class="sh">'</span><span class="p">:</span><span class="n">machine_name</span><span class="p">,</span> <span class="sh">'</span><span class="s">ResourceGroup</span><span class="sh">'</span><span class="p">:</span><span class="n">machine_rg</span><span class="p">,</span> <span class="sh">'</span><span class="s">OSType</span><span class="sh">'</span><span class="p">:</span><span class="n">machine_os</span><span class="p">,</span> <span class="sh">'</span><span class="s">Resource</span><span class="sh">'</span><span class="p">:</span><span class="n">machine_resource</span><span class="p">,</span> <span class="sh">'</span><span class="s">Tag</span><span class="sh">'</span><span class="p">:</span><span class="n">machine_tag</span><span class="p">}</span>
		<span class="n">connected_machines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">dic</span><span class="p">)</span></code></pre></figure> <p>At the end of this second step we have a list of machines that are eligible to be updated. In the next step, we will assign all these machines to different deployment schedules based on their tags.</p> <h4 id="step-2">Step 2</h4> <ol> <li>Iterate over all deployment schedules</li> <li> <img class="emoji" title=":gear:" alt=":gear:" src="https://github.githubassets.com/images/icons/emoji/unicode/2699.png" height="20" width="20"> Flush all machines that were assigned to the current deployment schedule</li> <li> <img class="emoji" title=":arrows_counterclockwise:" alt=":arrows_counterclockwise:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f504.png" height="20" width="20"> Iterate over all our connected machines * <img class="emoji" title=":white_check_mark:" alt=":white_check_mark:" src="https://github.githubassets.com/images/icons/emoji/unicode/2705.png" height="20" width="20"> Check if the machine tag and the deployment schedule match, otherwise continue * <img class="emoji" title=":gear:" alt=":gear:" src="https://github.githubassets.com/images/icons/emoji/unicode/2699.png" height="20" width="20"> Assign the machine to the deployment schedule</li> <li> <img class="emoji" title=":gear:" alt=":gear:" src="https://github.githubassets.com/images/icons/emoji/unicode/2699.png" height="20" width="20"> Update the deployment schedule</li> </ol> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">### 2. ITERATE OVER ALL DEPLOYMENT SCHEDULES AND REASSIGN MACHINES ###
# When using the Azure portal, deployment schedules have an associated schedule that defines when the patch will run.
# However, when using the Azure API, deployment schedules are actually made of :
#   - UpdateConfiguration objets, that defines which OS is targeted, which packages, etc.
#   - Schedule objets, that defines the reccurence, the start time, etc.
# The weird thing is that we can't retreive the Schedule from the UpdateConfiguration object.
# Thus, to resolve this, we get the list of UpdateConfiguration, we also get the list of Schedules, and we will make them match later.
</span><span class="n">update_configurations</span> <span class="o">=</span> <span class="n">automation_client</span><span class="p">.</span><span class="n">software_update_configurations</span><span class="p">.</span><span class="nf">list</span><span class="p">(</span><span class="n">resource_group_name</span><span class="p">,</span><span class="n">automation_account_name</span><span class="p">).</span><span class="n">value</span>
<span class="n">schedule_configurations</span> <span class="o">=</span> <span class="n">automation_client</span><span class="p">.</span><span class="n">schedule</span><span class="p">.</span><span class="nf">list_by_automation_account</span><span class="p">(</span><span class="n">resource_group_name</span><span class="p">,</span><span class="n">automation_account_name</span><span class="p">)</span>

<span class="c1"># In this long loop, we iterate over each UpdateConfiguration. 
</span><span class="k">for</span> <span class="n">update_configuration</span> <span class="ow">in</span> <span class="n">update_configurations</span><span class="p">:</span>
    <span class="c1"># Local vars
</span>    <span class="n">schedule</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># In this block of code, we clear the list of VMs that are currently assigned to the deployment schedule.
</span>    <span class="c1"># We need to do this because, if a VM tag is changed, the machine would appear in two deployments schedules.
</span>    <span class="n">software_update_configuration_p</span> <span class="o">=</span> <span class="n">automation_client</span><span class="p">.</span><span class="n">software_update_configurations</span><span class="p">.</span><span class="nf">get_by_name</span><span class="p">(</span><span class="n">resource_group_name</span><span class="p">,</span> <span class="n">automation_account_name</span><span class="p">,</span> <span class="n">update_configuration</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">software_update_configuration_p</span><span class="p">.</span><span class="n">update_configuration</span><span class="p">.</span><span class="n">non_azure_computer_names</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

    <span class="c1"># Here, we check the OS for which the deployment schedule is configured.
</span>    <span class="n">update_configuration_os</span> <span class="o">=</span> <span class="n">update_configuration</span><span class="p">.</span><span class="n">update_configuration</span><span class="p">.</span><span class="n">additional_properties</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">operatingSystem</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># In this block of code, we decide to ignore two types of deployment schedules :
</span>    <span class="c1">#   - MANUAL deployment schedules - Those deployment schedule are created to patch on-demand, they are part of another process
</span>    <span class="c1">#   - CENTOS deployment schedules - Those deployment schedule are created to patch CENTOS, they are part of another process
</span>    <span class="k">if</span> <span class="sh">"</span><span class="s">MANUAL</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">update_configuration</span><span class="p">.</span><span class="n">name</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">CENTOS</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">update_configuration</span><span class="p">.</span><span class="n">name</span><span class="p">:</span>
        <span class="k">continue</span>
    
    
    <span class="c1"># Remember line 9 when we retrieved the list of Schedules? We use this list to find the schedule associated to the current 
</span>    <span class="c1"># deployment schedule, based on name matching. We need to get this schedule to update it with a new start time. If we don't 
</span>    <span class="c1"># do this, the deployment schedule will be updated with a schedule that has a start_time in the past, and we will get an error.
</span>    <span class="c1"># Thus, we simply need to recalculate the start_time.
</span>    <span class="k">for</span> <span class="n">schedule_configuration</span> <span class="ow">in</span> <span class="n">schedule_configurations</span><span class="p">:</span>
        <span class="c1"># If update configuration and schedules match, then we found the right schedule
</span>        <span class="k">if</span> <span class="n">update_configuration</span><span class="p">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">schedule_configuration</span><span class="p">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">schedule</span> <span class="o">=</span> <span class="n">automation_client</span><span class="p">.</span><span class="n">schedule</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">resource_group_name</span><span class="p">,</span> <span class="n">automation_account_name</span><span class="p">,</span> <span class="n">schedule_configuration</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>


    <span class="c1"># In this block of code, we iterate over our connected machine to check if we should assign them to the current
</span>    <span class="c1"># deployment schedule by checking OS and tags. If the VM matches our criteria, it is added to the list of 
</span>    <span class="c1"># machines that will be assigned to the deployment schedule.
</span>    <span class="k">for</span> <span class="n">connected_machine</span> <span class="ow">in</span> <span class="n">connected_machines</span><span class="p">:</span>
        <span class="c1"># Get connected machine attributes
</span>        <span class="n">machine_rg</span> <span class="o">=</span> <span class="n">connected_machine</span><span class="p">[</span><span class="sh">'</span><span class="s">ResourceGroup</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">machine_name</span> <span class="o">=</span> <span class="n">connected_machine</span><span class="p">[</span><span class="sh">'</span><span class="s">Computer</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">machine_resource</span> <span class="o">=</span> <span class="n">connected_machine</span><span class="p">[</span><span class="sh">'</span><span class="s">Resource</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">machine_os</span> <span class="o">=</span> <span class="n">connected_machine</span><span class="p">[</span><span class="sh">'</span><span class="s">OSType</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">machine_tag</span> <span class="o">=</span> <span class="n">connected_machine</span><span class="p">[</span><span class="sh">'</span><span class="s">Tag</span><span class="sh">'</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">machine_tag</span><span class="p">:</span>
            <span class="nf">if </span><span class="p">(</span><span class="n">machine_os</span> <span class="ow">in</span> <span class="n">update_configuration_os</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">machine_tag</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s">:</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="p">)</span> <span class="ow">in</span> <span class="n">update_configuration</span><span class="p">.</span><span class="n">name</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">machine_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">software_update_configuration_p</span><span class="p">.</span><span class="n">update_configuration</span><span class="p">.</span><span class="n">non_azure_computer_names</span><span class="p">:</span>
                    <span class="c1"># Add machine to the list
</span>                    <span class="n">software_update_configuration_p</span><span class="p">.</span><span class="n">update_configuration</span><span class="p">.</span><span class="n">non_azure_computer_names</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">machine_name</span><span class="p">)</span>

    <span class="c1"># In this next block of code, we calculate the new start time for the schedule.
</span>	<span class="c1"># IMPORTANT : because the runbook runs between 15:00 and 18:00, we must schedule it as follows :
</span>	<span class="c1">#	   - For 03:00 schedules =&gt; Schedule it on 'day+1', since 03:00 of the current day is in the past
</span>	<span class="c1">#	   - For 12:00 schedules =&gt; Schedule it on 'day+1', since 03:00 of the current day is in the past
</span>	<span class="c1">#	   - For 22:00 schedules =&gt; Schedule it on 'day', since 22:00 of the current day is in a few hours
</span>	<span class="n">hours</span> <span class="o">=</span> <span class="n">software_update_configuration_p</span><span class="p">.</span><span class="n">schedule_info</span><span class="p">.</span><span class="n">start_time</span>
	<span class="n">date</span> <span class="o">=</span> <span class="nf">datetime</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">().</span><span class="n">year</span><span class="p">,</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">().</span><span class="n">month</span><span class="p">,</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">().</span><span class="n">day</span><span class="p">)</span>
	<span class="k">if</span> <span class="sh">"</span><span class="s">22-00</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">update_configuration</span><span class="p">.</span><span class="n">name</span><span class="p">:</span>
		<span class="n">day</span> <span class="o">=</span> <span class="n">date</span><span class="p">.</span><span class="n">day</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">day</span> <span class="o">=</span> <span class="n">date</span><span class="p">.</span><span class="n">day</span><span class="o">+</span><span class="mi">1</span>
	<span class="n">software_update_configuration_p</span><span class="p">.</span><span class="n">schedule_info</span><span class="p">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="nf">datetime</span><span class="p">(</span><span class="n">date</span><span class="p">.</span><span class="n">year</span><span class="p">,</span> <span class="n">date</span><span class="p">.</span><span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hours</span><span class="p">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">hours</span><span class="p">.</span><span class="n">minute</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
	
    <span class="c1"># When creating a deployment schedule, VMs must be assigned to it, otherwise we will get an error at deployment time.
</span>    <span class="c1"># Here are the different options to assign machines to a deployment schedule :
</span>    <span class="c1">#   - Assign machines statically : this is what our script do
</span>    <span class="c1">#   - Assign machines dynamically using a query
</span>    <span class="c1"># Thus, when we have no machine assigned to a deployment schedule, we need to create a create and assign it a query.
</span>    <span class="c1"># The query does not return any VM, it only allows us to deploy our delpoyment schedule without any error.
</span>    <span class="n">non_azure_query</span> <span class="o">=</span> <span class="nc">NonAzureQueryProperties</span><span class="p">()</span>
    <span class="n">non_azure_query</span><span class="p">.</span><span class="n">function_alias</span> <span class="o">=</span> <span class="n">saved_searche_id</span>
    <span class="n">non_azure_query</span><span class="p">.</span><span class="n">workspace_id</span> <span class="o">=</span> <span class="n">workspace_resource_id</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">software_update_configuration_p</span><span class="p">.</span><span class="n">update_configuration</span><span class="p">.</span><span class="n">targets</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Error processing this maintenance schdule : </span><span class="sh">"</span> <span class="o">+</span> <span class="n">update_configuration</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">continue</span>
    <span class="n">software_update_configuration_p</span><span class="p">.</span><span class="n">update_configuration</span><span class="p">.</span><span class="n">targets</span><span class="p">.</span><span class="n">non_azure_queries</span> <span class="o">=</span> <span class="p">[</span><span class="n">non_azure_query</span><span class="p">]</span>

    <span class="c1"># Finally we update our deployment schedule, and we handle an error that Azure may raise which is related to the number of request we send.
</span>    <span class="c1"># If we receive the error, the script will sleep for a random amount of time between 30 and 90 seconds.
</span>    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">automation_client</span><span class="p">.</span><span class="n">software_update_configurations</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">resource_group_name</span><span class="p">,</span> <span class="n">automation_account_name</span><span class="p">,</span> <span class="n">update_configuration</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">software_update_configuration_p</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="n">HttpResponseError</span><span class="p">:</span>
            <span class="nf">print </span><span class="p">(</span><span class="sh">"</span><span class="s">Exception HttpResponseError (Erreur 429 : too much API calls)</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
            <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></code></pre></figure> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2025 CyberIntruder - Molx32 . </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-MFVVRMM3DK"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-MFVVRMM3DK");</script> </body> </html>