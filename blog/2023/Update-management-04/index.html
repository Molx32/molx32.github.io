<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> CyberIntruder | Blog </title> <meta name="author" content="CyberIntruder - Molx32 "/> <meta name="description" content="This post is describes the architecture of the solution"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light"/> <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚛️</text></svg>"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://cyber-intruder.com/blog/2023/Update-management-04/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="https://cyber-intruder.com/">CyberIntruder</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/about">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/fr-fr/blog/2023/Update-management-04/"> FR-FR </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Azure Update Management - Part 5 - Automation accounts</h1> <p class="post-meta">February 2, 2023</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/updatemanagement"> <i class="fas fa-hashtag fa-sm"></i> updatemanagement</a>   </p> </header> <article class="post-content"> <p><i>Hello there, the goal of this serie is to describe a real world implementation of <b>Azure Update Management</b>. This service was designed to update any machine in your infrastructure, whether they are hosted on Azure or elsewhere, provided your OSs are technically supported.</i></p> <p><i>In order for every reader to understand and find answers to their need, to I’ll try to give a comprehensive feedback from my experience, as well as sharing tips about design and architecture, automation, effectivement, troubleshooting issues, and so on!</i></p> <p><i>Have a nice reading.</i></p> <hr> <h4 id="plan">Plan</h4> <ul> <li><a href="/blog/2022/Update-management-00/">Part 0 - Introduction</a></li> <li><a href="/blog/2022/Update-management-01/">Part 1 - Architecture</a></li> <li><a href="/blog/2022/Update-management-011/">Part 2 - Azure Policy</a></li> <li><a href="/blog/2022/Update-management-02/">Part 3 - Azure ARC</a></li> <li><a href="/blog/2022/Update-management-03/">Part 4 - Log Analytics agents</a></li> <li><b><a href="/blog/2023/Update-management-04/">Part 5 - Automation accounts (you’re here)</a></b></li> <li><a href="/blog/2023/Update-management-05/">Part 6 - Monitoring</a></li> <li><a href="/blog/2023/Update-management-06/">Part 7 - Security patches on Azure ARC</a></li> <li><a href="/blog/2023/Update-management-07/">Part 8 - Security patches on CentOS machines</a></li> </ul> <hr> <h2 id="introduction">Introduction</h2> <p>In the previous post we saw how the basic and simple properties of a Log Analytics workspace. We also saw how to deploy Log Analytics agents with various methods. In this method, you will find all you need to know about Automation Account and their update management feature.</p> <h2 id="context">Context</h2> <p>This part will be very important since it define all the strategy to configure the Automation Accounts. So, if you remember my introduction post, we want to update machines bases on the following rules :</p> <ul> <li>Apply only security and critical patches</li> <li>Apply patches once a week</li> <li>Reboot only if needed</li> </ul> <p>All of this can be configured in In addition to those rules, we will configure <b>deployment schedules</b>, which are some sort of automation accounts sub-resources. For each automation account, we will 21 deployement schedule! This is a lot, be let me explain : the goal of this solution is to allow any business application to patched. To make it possible, we need to propose many schedules to comply with all application constraints. So we decided to propose 3 schedule maintenance per day : at 3:00, 12:00, and 22:00 (3*7 = 21 schedules).</p> <p>My ultimate goal with this is to create a deployment schedule that select the appropriate machines, based on machines tags. Just imagine how simple it would be : if a machine must be updated, I assign a tag to it (the tag <b>MON-03:00</b> for instance), and I know that my deployment schedules will update it. Let’s see how to do this!</p> <table id="custom" class="t-border"> <caption style="text-align:center"><b>Schedules available for VM updates</b></caption> <tr> <th>MON</th> <th>TUE</th> <th>WED</th> <th>THU</th> <th>FRI</th> <th>SAT</th> <th>SUN</th> </tr> <tr> <td>MON-03:00</td> <td>TUE-03:00</td> <td>WED-03:00</td> <td>THU-03:00</td> <td>FRI-03:00</td> <td>SAT-03:00</td> <td>SUN-03:00</td> </tr> <tr> <td>MON-12:00</td> <td>TUE-12:00</td> <td>WED-12:00</td> <td>THU-12:00</td> <td>FRI-12:00</td> <td>SAT-12:00</td> <td>SUN-12:00</td> </tr> <tr> <td>MON-22:00</td> <td>TUE-22:00</td> <td>WED-22:00</td> <td>THU-22:00</td> <td>FRI-22:00</td> <td>SAT-22:00</td> <td>SUN-22:00</td> </tr> </table> <hr> <h2 id="automation-accounts">Automation accounts</h2> <h3 id="create-deployment-schedule">Create deployment schedule</h3> <p>We can create a first deployment schedule to check what it looks like.</p> <ol> <li>Create an Automation Account if not done</li> <li>Navigate to your Automation Account</li> <li>Navigate to the <b>Update management</b> pane</li> <li>Click on <b>Schedule update deployment</b> </li> <li>You will see settings to be configured as described in the following table.</li> </ol> <table id="custom" class="t-border"> <caption style="text-align:center"><b>Deployment schedule settings</b></caption> <tr> <th>Name</th> <th>Description</th> <th>Value</th> </tr> <tr> <td>Name</td> <td>This is the name of the deployment schedule</td> <td>LIN-MON-03:00</td> </tr> <tr> <td>Operating System</td> <td>Surprise! A deployment schedule is dedicated to only one OS.</td> <td>LINUX</td> </tr> <tr> <td>Groups to update</td> <td>Dynamic selection of machines to update</td> <td>C.f. below</td> </tr> <tr> <td>Machines to update</td> <td>Selection of machines to update</td> <td>C.f. below</td> </tr> <tr> <td>Update classification</td> <td>I mentioned before, we only want security and critical here</td> <td>Critical and security updates</td> </tr> <tr> <td>Include/exclude updates</td> <td>You may want to include/exclude specific updates. We can leave this blank.</td> <td>-</td> </tr> <tr> <td>Pre-script + Post script</td> <td>You may want to push and execute script before or after updates. We can leave this blank</td> <td>-</td> </tr> <tr> <td>Maintenance window</td> <td>Duration of the maintenance schedule.</td> <td>120</td> </tr> <tr> <td>Reboot options</td> <td>Reboot if required</td> <td>120</td> </tr> </table> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/automation_account_1-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/automation_account_1-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/automation_account_1-1400.webp"></source> <img src="/assets/img/automation_account_1.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>What we observe so far is that we can’t merge Linux and Windows in the same deployment schedule, so our deployment schedules will now look like this :</p> <table id="custom" class="t-border"> <caption style="text-align:center"><b>Schedules available for VM updates</b></caption> <tr> <th>OS</th> <th>MON</th> <th>TUE</th> <th>WED</th> <th>THU</th> <th>FRI</th> <th>SAT</th> <th>SUN</th> </tr> <tr> <td>Windows</td> <td>WIN-MON-03:00</td> <td>WIN-TUE-03:00</td> <td>WIN-WED-03:00</td> <td>WIN-THU-03:00</td> <td>WIN-FRI-03:00</td> <td>WIN-SAT-03:00</td> <td>WIN-SUN-03:00</td> </tr> <tr> <td>Windows</td> <td>WIN-MON-12:00</td> <td>WIN-TUE-12:00</td> <td>WIN-WED-12:00</td> <td>WIN-THU-12:00</td> <td>WIN-FRI-12:00</td> <td>WIN-SAT-12:00</td> <td>WIN-SUN-12:00</td> </tr> <tr> <td>Windows</td> <td>WIN-MON-22:00</td> <td>WIN-TUE-22:00</td> <td>WIN-WED-22:00</td> <td>WIN-THU-22:00</td> <td>WIN-FRI-22:00</td> <td>WIN-SAT-22:00</td> <td>WIN-SUN-22:00</td> </tr> <tr> <td>Linux</td> <td>LIN-MON-03:00</td> <td>LIN-TUE-03:00</td> <td>LIN-WED-03:00</td> <td>LIN-THU-03:00</td> <td>LIN-FRI-03:00</td> <td>LIN-SAT-03:00</td> <td>LIN-SUN-03:00</td> </tr> <tr> <td>Linux</td> <td>LIN-MON-12:00</td> <td>LIN-TUE-12:00</td> <td>LIN-WED-12:00</td> <td>LIN-THU-12:00</td> <td>LIN-FRI-12:00</td> <td>LIN-SAT-12:00</td> <td>LIN-SUN-12:00</td> </tr> <tr> <td>Linux</td> <td>LIN-MON-22:00</td> <td>LIN-TUE-22:00</td> <td>LIN-WED-22:00</td> <td>LIN-THU-22:00</td> <td>LIN-FRI-22:00</td> <td>LIN-SAT-22:00</td> <td>LIN-SUN-22:00</td> </tr> </table> <p>Let’s continue with the settings groups to update and machines to update, which are both settings that allow you to choose which machines should be updated with the current deployment schedule.</p> <h4 id="machines-to-update">Machines to update</h4> <p>When using this feature, we can define a group of machines to target with the current deployment schedule. This group of machines can be created from multiple sources as discussed in the <a href="https://learn.microsoft.com/en-us/azure/azure-monitor/logs/computer-groups" target="_blank" rel="noopener noreferrer">Microsoft documentation</a> :</p> <ul> <li>Log query</li> <li>Log search API</li> <li>Active Directory</li> <li>Configuration Manager</li> <li>Windows Server Update Services</li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/automation_account_2-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/automation_account_2-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/automation_account_2-1400.webp"></source> <img src="/assets/img/automation_account_2.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>As mentioned in the first part of this post, I want my VMs to be updated if they have a specific tag. Unfortunately, with this setting, we can’t update machines based on their tags! So let’s take a look at the <b>Groups to update</b> feature then.</p> <h4 id="groups-to-update">Groups to update</h4> <p>As described in the Microsoft documentation, we can filter machines based on their tags, awesome right? So this will be our solution, but our solution has an important limitation : this does not apply to Azure ARC VMs! This is immediately not so awesome… But I have a workaround that I will describe in a future post, so let’s continue with Azure VM only for now.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/automation_account_3-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/automation_account_3-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/automation_account_3-1400.webp"></source> <img src="/assets/img/automation_account_3.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/automation_account_4-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/automation_account_4-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/automation_account_4-1400.webp"></source> <img src="/assets/img/automation_account_4.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>I recommend to do some testing if you want to get familiar with deployment schedules capabilities. If you want to go straight foreward, let’s deploy some stuff now!</p> <hr> <h2 id="deployment">Deployment</h2> <p>The only thing you need to do for deployment is to create a dedicated resource group where our resources will be deployed. You will need two files :</p> <ul> <li>The <a href="https://raw.githubusercontent.com/Molx32/AzureUpdateManagement/main/arm/core_infrastructure_azure.json" target="_blank" rel="noopener noreferrer">core_infrastructure_azure.json</a> file is a simple ARM template that describe the architecture we’re about to deploy.</li> <li>The <a href="https://raw.githubusercontent.com/Molx32/AzureUpdateManagement/main/arm/core_infrastructure_azure.parameters.json" target="_blank" rel="noopener noreferrer">core_infrastructure_azure.parameters.json</a> file is a parameter file where you can change resources names.</li> </ul> <p>Before running the commands below, make sure you chose an existing resource group or created one.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az login
az account set --subscription &lt;subscriptionId&gt;
az deployment group create --name &lt;anyName&gt; --resource-group &lt;resourceGroupName&gt; --template-file core_infrastructure_azure.json --parameters core_infrastructure_azure.parameters.json
</code></pre></div></div> <p>Here is a sample output for deployment.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/automation_account_5-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/automation_account_5-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/automation_account_5-1400.webp"></source> <img src="/assets/img/automation_account_5.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <hr> <p>What did we deployed? We deployed the three following resources.</p> <table id="custom" class="t-border"> <caption style="text-align:center"><b>Resource deployed</b></caption> <tr> <th>Resource name</th> <th>Description</th> </tr> <tr> <td>Updates(updtmgmt-la)</td> <td>This is a resource that is deployed on top of a Log Analytics, and that usually provide graphs. To be honest I never reversed engineered this to understand how it works, but I think this enables charts to be displayed within the automation account.</td> </tr> <tr> <td>updtmgmt-aa</td> <td>This is the automation account, which is linked to the Log Analytics workspace</td> </tr> <tr> <td>updtmgmt-la</td> <td>This is the log analytics workspace that collects our update data</td> </tr> </table> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/automation_account_6-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/automation_account_6-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/automation_account_6-1400.webp"></source> <img src="/assets/img/automation_account_6.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>We can’t see deployment schedule here : we can view them from the automation account, so navigate to the resource, and you will see two deployment schedules that look the same, expect one is for Windows OS, the other for Linux.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/automation_account_7-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/automation_account_7-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/automation_account_7-1400.webp"></source> <img src="/assets/img/automation_account_7.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>If you take a look at the Linux deployment schedule, you will see the configuration we pushed through our ARM template. In the <b>Groups to update</b> setting, we look for machines located in the current subscription and tagged with <b>patch:LINUX-MON-03:00</b> tag.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/automation_account_8-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/automation_account_8-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/automation_account_8-1400.webp"></source> <img src="/assets/img/automation_account_8.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>Now that the core infratructure is deployed, we can assign an Azure policy (c.f. Part 2 of the serie) to the subscription scope and enforce Log Analytics agent to report to our newly deployed Log Analytics workspace. Then you can deploy a VM that will be directly onboarded!</p> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2025 CyberIntruder - Molx32 . </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-MFVVRMM3DK"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-MFVVRMM3DK");</script> </body> </html>