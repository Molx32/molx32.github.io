<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> CyberIntruder | Blog </title> <meta name="author" content="CyberIntruder - Molx32 "/> <meta name="description" content="This post is describes the architecture of the solution"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light"/> <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚛️</text></svg>"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://cyber-intruder.com/blog/2023/Update-management-05/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="https://cyber-intruder.com/">CyberIntruder</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/about">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/fr-fr/blog/2023/Update-management-05/"> FR-FR </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Azure Update Management - Part 6 - Monitoring</h1> <p class="post-meta">February 2, 2023</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/updatemanagement"> <i class="fas fa-hashtag fa-sm"></i> updatemanagement</a>   </p> </header> <article class="post-content"> <p><i>Hello there, the goal of this serie is to describe a real world implementation of <b>Azure Update Management</b>. This service was designed to update any machine in your infrastructure, whether they are hosted on Azure or elsewhere, provided your OSs are technically supported.</i></p> <p><i>In order for every reader to understand and find answers to their need, to I’ll try to give a comprehensive feedback from my experience, as well as sharing tips about design and architecture, automation, effectivement, troubleshooting issues, and so on!</i></p> <p><i>Have a nice reading.</i></p> <hr> <h4 id="plan">Plan</h4> <ul> <li><a href="/blog/2022/Update-management-00/">Part 0 - Introduction</a></li> <li><a href="/blog/2022/Update-management-01/">Part 1 - Architecture</a></li> <li><a href="/blog/2022/Update-management-011/">Part 2 - Azure Policy</a></li> <li><a href="/blog/2022/Update-management-02/">Part 3 - Azure ARC</a></li> <li><a href="/blog/2022/Update-management-03/">Part 4 - Log Analytics agents</a></li> <li><a href="/blog/2023/Update-management-04/">Part 5 - Automation accounts</a></li> <li><b><a href="/blog/2023/Update-management-05/">Part 6 - Monitoring (you’re here)</a></b></li> <li><a href="/blog/2023/Update-management-06/">Part 7 - Security patches on Azure ARC</a></li> <li><a href="/blog/2023/Update-management-07/">Part 8 - Security patches on CentOS machines</a></li> </ul> <h2 id="purpose">Purpose</h2> <p>In this article, I assume you connected all your virtual machines. What you may want now is monitoring you virtual machines. The usual way to monitor updates is navigate to the automation account, then take a look at your VMs.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/updt_mgmt_monitoring_01-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/updt_mgmt_monitoring_01-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/updt_mgmt_monitoring_01-1400.webp"></source> <img src="/assets/img/updt_mgmt_monitoring_01.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>This is a very poor view, and we sure can do way better! And I actually developed a ready to use monitoring workbook that you need to slightly tweak to meet your needs. Ready to discover that sick workbook? Here is a short video.</p> <div class="col-sm mt-3 mt-md-0"> <iframe width="560" height="315" src="https://www.youtube.com/embed/6asRTPWqYmg" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen=""></iframe> </div> <h2 id="deploy">Deploy</h2> <p>To get the same awesome dashboard, just copy the code hosted on my <a href="https://github.com/Molx32/AwesomeAzureWorkbooks/blob/main/Workbooks/update-management.json" target="_blank" rel="noopener noreferrer">Github</a>, and follow these steps :</p> <ol> <li>Create a new workbook</li> <li>Edit the workbook and select the advanced editor (gallery template)</li> <li>Paste the code</li> <li>Save</li> </ol> <p>You should end up with something that looks like this. Let’s adapt this to make it work.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/updt_mgmt_monitoring_00-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/updt_mgmt_monitoring_00-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/updt_mgmt_monitoring_00-1400.webp"></source> <img src="/assets/img/updt_mgmt_monitoring_00.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <h2 id="adapt">Adapt</h2> <h3 id="customize-general-filters">Customize general filters</h3> <p>The goal of this section is to show how to create filters button so that you can customize them. In my case, the update management architecture is made of the of multiple Log Analytics workspaces that collect VMs update data. In order to monitor data only on those Log Analytics workspaces, we tag them with the tag <b>application:update management</b> to that we can filter them. Then we also add the following tags to our log analytics based on their CSP and their environment. This is summed up in the following table.</p> <table id="custom" class="t-border"> <caption style="text-align:center"><b>Resource deployed</b></caption> <tr> <th>Log Analytics name</th> <th>Second priority</th> <th>CSP tag</th> <th>Environment tag</th> <th>Application tag</th> </tr> <tr> <td>loga-azure-001</td> <td>Azure</td> <td>azure</td> <td>prod</td> <td>update management</td> </tr> <tr> <td>loga-oci-001</td> <td>Azure</td> <td>oci</td> <td>prod</td> <td>update management</td> </tr> <tr> <td>loga-gcp-001</td> <td>Azure</td> <td>gcp</td> <td>prod</td> <td>update management</td> </tr> <tr> <td>loga-ovh-001</td> <td>Azure</td> <td>ovh</td> <td>prod</td> <td>update management</td> </tr> <tr> <td>loga-np-azure-001</td> <td>Azure</td> <td>azure</td> <td>no prod</td> <td>update management</td> </tr> <tr> <td>loga-np-oci-001</td> <td>Azure</td> <td>oci</td> <td>no prod</td> <td>update management</td> </tr> <tr> <td>loga-np-gcp-001</td> <td>Azure</td> <td>gcp</td> <td>no prod</td> <td>update management</td> </tr> <tr> <td>loga-np-ovh-001</td> <td>Azure</td> <td>ovh</td> <td>no prod</td> <td>update management</td> </tr> </table> <p>Once this has been done, let’s create our filter buttons by editing and add <b>Add links/tabs</b>.</p> <h4 id="create-a-first-parameter-named-csp">Create a first parameter named CSP</h4> <p>This will create a drop down button where we can select the different CSPs where our VMs are deployed, in order to filter our view by CSP.</p> <ol> <li>Make it a drop down</li> <li>Make it a required parameter</li> <li>Allow multiple selection</li> <li>Set a static JSON and save</li> </ol> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/updt_mgmt_monitoring_021-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/updt_mgmt_monitoring_021-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/updt_mgmt_monitoring_021-1400.webp"></source> <img src="/assets/img/updt_mgmt_monitoring_021.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <h4 id="create-a-first-parameter-named-environment">Create a first parameter named Environment</h4> <p>This will create a drop down button where we can select the environment (prod, no prod) in order to filter our view by environment.</p> <ol> <li>Make it a resource picker</li> <li>Make it a required parameter</li> <li>Allow multiple selection</li> <li>Set the query as shown on the screen shot</li> </ol> <p>This request selects all Log Analytics workspaces that have the tag <b>application:update management</b>, and returns the list of all unique <b>environment</b> tags positionned on these Log Analytics.</p> <figure class="highlight"><pre><code class="language-kql" data-lang="kql">where type =~ 'microsoft.operationalinsights/workspaces'
&lt;td&gt;where tolower(tostring(tags.application)) == "update management"
&lt;td&gt;distinct tostring(tags.environment)</code></pre></figure> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/updt_mgmt_monitoring_022-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/updt_mgmt_monitoring_022-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/updt_mgmt_monitoring_022-1400.webp"></source> <img src="/assets/img/updt_mgmt_monitoring_022.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <h4 id="create-a-first-parameter-named-workspaces">Create a first parameter named Workspaces</h4> <p>The selected values in our two previous buttons will make this third and last button to return different values.</p> <ol> <li>Make it a resource picker</li> <li>Make it a required parameter</li> <li>Allow multiple selection</li> <li>Check the “Hide parameter in reading mode” feature</li> <li>Set the query as shown on the screen shot</li> </ol> <p>This request selects all Log Analytics workspaces that have the tag <b>application:update management</b>, and return all Log Analytics workspaces that have CSP tag and Environment tags that matches the selection we made using the previous buttons.</p> <figure class="highlight"><pre><code class="language-kql" data-lang="kql">where type =~ 'microsoft.operationalinsights/workspaces'
&lt;td&gt;where tolower(tostring(tags.application)) == "update management"
&lt;td&gt;distinct tostring(tags.environment)</code></pre></figure> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/updt_mgmt_monitoring_023-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/updt_mgmt_monitoring_023-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/updt_mgmt_monitoring_023-1400.webp"></source> <img src="/assets/img/updt_mgmt_monitoring_023.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <hr> <p>If you didn’t change too much things, the result for this first step should look like this.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/updt_mgmt_monitoring_024-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/updt_mgmt_monitoring_024-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/updt_mgmt_monitoring_024-1400.webp"></source> <img src="/assets/img/updt_mgmt_monitoring_024.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <h3 id="customize-job-filters">Customize job filters</h3> <p>In my case, VMs have specific tags to easily know when they are supposed to update and reboot. For instance, a production machine (P) that updates and reboots on wednesday (WED) at 12:00 (12:00) will be tagged with <b>patch:P-WED-12:00</b>. Because I have a lot of machines, I wanted to filter the jobs so that I can observe the jobs of all machines that updated on a specific day, or a specific hour.</p> <p>Based on your needs, you either remove or adapt what is highlighted on the following screenshot.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/updt_mgmt_monitoring_03-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/updt_mgmt_monitoring_03-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/updt_mgmt_monitoring_03-1400.webp"></source> <img src="/assets/img/updt_mgmt_monitoring_03.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <h2 id="additional-info">Additional info</h2> <p>So what do we have to monitor our VMs? Our VMs send the followinf logs, thanks to the Log Analytics agent that are runnin on them:</p> <ul> <li>The <i>Update</i> table represents updates available and their installation status for a machine. This is table we will mainly use.</li> <li>The <i>UpdateRunProgress</i> table provides update deployment status of a scheduled deployment by machine. It will show the status of update deployments i.e. whether it was successful or not.</li> <li>The <i>UpdateSummary</i> table provides update summary by machine. This is some sort of agregrate of the Update table.</li> </ul> <p>You can find some query examples using these tables in the <a href="https://learn.microsoft.com/en-us/azure/automation/update-management/query-logs" target="_blank" rel="noopener noreferrer">Microsoft documentation</a>.</p> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2025 CyberIntruder - Molx32 . </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-MFVVRMM3DK"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-MFVVRMM3DK");</script> </body> </html>